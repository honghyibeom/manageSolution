<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>ÌÜµÍ≥Ñ</title>
    <style>
        .no-bg {
            background-color: transparent !important;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<main layout:fragment="content">
    <div class ="container">
        <h4 class="fw-bold mb-4">ÌÜµÍ≥Ñ</h4>

    <p class="mb-4 fw-bold" th:text="${today} + ' Í∏∞Ï§Ä Îß§Ï∂úÌòÑÌô©ÏûÖÎãàÎã§.'">
        yyyyÎÖÑ MMÏõî ddÏùº
    </p>
        <div class="row g-3 mb-4 p-3 rounded " style="background:#e6f7ff">
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm text-dark">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Ï¥ù Îß§Ï∂ú</h6>
                        <h5 class="fw-bold text-end" th:text="${#numbers.formatInteger(sales.totalSales, 0,'COMMA')} + 'Ïõê'">334,197,202Ïõê</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm text-dark">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Ïõî Îß§Ï∂ú</h6>
                        <h5 class="fw-bold text-end" th:text="${#numbers.formatInteger(sales.monthlySales, 0,'COMMA')} + 'Ïõê'">11,924,500Ïõê</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm text-dark">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Ïùº Îß§Ï∂ú</h6>
                        <h5 class="fw-bold text-end" th:text="${#numbers.formatInteger(sales.dailySales, 0,'COMMA')} + 'Ïõê'">0Ïõê</h5>
                    </div>
                </div>
            </div>
        </div>

        <!-- Í∏∞Í∞Ñ & ÌÉÄÏûÖ ÏÑ†ÌÉù -->
        <div class="p-3 mb-3 bg-light rounded border d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
                <label class="fw-bold mb-0">Í∏∞Í∞ÑÏ°∞Ìöå</label>
                <input type="date" class="form-control form-control-sm w-auto" id="startDate">
                <span>~</span>
                <input type="date" class="form-control form-control-sm w-auto" id="endDate">
            </div>

            <div class="btn-group" role="group">
                <button class="btn btn-outline-secondary" data-type="year">ÎÖÑ</button>
                <button class="btn btn-outline-secondary" data-type="month">Ïõî</button>
                <button class="btn btn-outline-secondary" data-type="day">Ïùº</button>
            </div>
        </div>

        <!--Ï∞®Ìä∏-->
        <div class="container m-4">
            <canvas id="salesChart" width="300" height="100"></canvas>
        </div>

        <!-- ÌÖåÏù¥Î∏î -->
        <div class="row gx-4" id="tablesContainer">
            <div class="col-12 col-md-6" id="ptTableContainer"></div>
            <div class="col-12 col-md-6" id="membershipTableContainer"></div>
        </div>

    </div>

    <script>
        let chart = null;

        // üîπ Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞
        function renderChart(labels, salesData) {
            console.log(labels); // Î∞∞Ïó¥Ïù¥Ïñ¥Ïïº Ìï®
            console.log(salesData); // Î∞∞Ïó¥Ïù¥Ïñ¥Ïïº Ìï®

            const ctx = document.getElementById('salesChart').getContext('2d');
            if (chart) chart.destroy(); // Í∏∞Ï°¥ Ï∞®Ìä∏ Ï†úÍ±∞

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Îß§Ï∂ú',
                        data: salesData,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // üîπ ÌÖåÏù¥Î∏î Í∑∏Î¶¨Í∏∞ (Ïû¨ÏÇ¨Ïö©)
        function renderTable(containerId, title, members, summary, columns) {
            const html = `
        <div>
            <div class="card shadow-sm h-100">
                <div class="card-header fw-bold text-center">${title}</div>

                <div class="card-body">
                    <div class="table-responsive" style="height: 400px; max-height: 400px; overflow-y: auto;">
                        <table class="table table-bordered text-center align-middle mb-0">
                            <thead class="table-light">
                                <tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr>
                            </thead>
                            <tbody>
                                ${members.map(m => `
                                    <tr>
                                        ${Object.values(m).map(v =>
                                            `<td>${typeof v === 'number' ? v.toLocaleString('ko-KR') : v}</td>`
                                        ).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="bg-dark text-white text-center py-2 rounded mt-3 mb-3">
                    Ï¥ùÌï©: <span>${summary.totalAmount.toLocaleString()}Ïõê</span> /
                    Ï¥ù Í±¥Ïàò: <span>${summary.count}Í∞ú</span>
            </div>
        </div>
         `;
            document.getElementById(containerId).innerHTML = html;
        }

        function fillMissingDates(startDateStr, endDateStr, labels, salesData, type) {
            const resultMap = {};
            for (let i = 0; i < labels.length; i++) {
                resultMap[labels[i]] = salesData[i];
            }

            const completeLabels = [];
            const completeSales = [];

            const start = new Date(startDateStr);
            const end = new Date(endDateStr);

            const current = new Date(start);
            const endCheck = new Date(end);

            if (type === 'month') {
                current.setDate(1);
                endCheck.setDate(1);
            }
            if (type === 'year') {
                current.setMonth(0);
                current.setDate(1);
                endCheck.setMonth(0);
                endCheck.setDate(1);
            }

            while (current <= endCheck) {
                let label;

                if (type === 'year') {
                    label = current.getFullYear().toString();
                    current.setFullYear(current.getFullYear() + 1);
                } else if (type === 'month') {
                    label = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`;
                    current.setMonth(current.getMonth() + 1);
                } else {
                    label = current.toISOString().slice(0, 10);
                    current.setDate(current.getDate() + 1);
                }

                completeLabels.push(label);
                completeSales.push(resultMap[label] ?? 0);
            }

            return {
                labels: completeLabels,
                salesData: completeSales
            };
        }


        // üîπ ÌÜµÍ≥Ñ Î°úÎî©
        function loadStatistics(type) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert("Ï°∞ÌöåÌï† ÎÇ†ÏßúÎ•º Î™®Îëê ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
                return;
            }

            axios.get('/statistics/api', {
                params: {
                    start: startDate,
                    end: endDate,
                    type: type
                }
            })
                .then(response => {
                    const data = response.data;

                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    const completed = fillMissingDates(startDate, endDate, data.labels, data.salesData, type);

                    renderChart(completed.labels, completed.salesData);

                    renderTable(
                        'ptTableContainer',
                        'PTÍ∂å ÌÜµÍ≥Ñ',
                        data.ptMembers,
                        data.ptSummary,
                        ['ÏÉÅÌíàÎ™Ö', 'Í±¥Ïàò', 'Í∏àÏï°', 'Ï¥ù Í∏àÏï°']
                    );

                    renderTable(
                        'membershipTableContainer',
                        'ÌöåÏõêÍ∂å ÌÜµÍ≥Ñ',
                        data.membershipMembers,
                        data.membershipSummary,
                        ['ÏÉÅÌíàÎ™Ö', 'Í±¥Ïàò', 'Í∏àÏï°', 'Ï¥ù Í∏àÏï°']
                    );
                })
                .catch(error => {
                    console.error('‚ùå ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                    alert("Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                });
        }

        document.addEventListener("DOMContentLoaded", function () {
            // üî∑ Ïò§ÎäòÍ≥º 6Í∞úÏõî Ï†Ñ ÎÇ†Ïßú Í≥ÑÏÇ∞
            const today = new Date();
            const endDateStr = today.toISOString().split('T')[0];

            const sixMonthsAgo = new Date(today);
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 5);
            sixMonthsAgo.setDate(1); // Ìï¥Îãπ Îã¨Ïùò 1Ïùº
            const startDateStr = sixMonthsAgo.toISOString().split('T')[0];

            // üî∑ inputÏóê Ï¥àÍ∏∞Í∞í ÏÑ∏ÌåÖ
            document.getElementById('startDate').value = startDateStr;
            document.getElementById('endDate').value = endDateStr;

            // üî∑ Î≤ÑÌäº Ï§ë 'Ïõî' Î≤ÑÌäºÏùÑ active Ï≤òÎ¶¨
            const monthBtn = document.querySelector('.btn-group button[data-type="month"]');
            if (monthBtn) {
                monthBtn.classList.add('btn-primary');
                monthBtn.style.color = 'white';
            }

            // üî∑ Ï¥àÍ∏∞ Î°úÎìú
            loadStatistics("month");

            // üî∑ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Î≤ÑÌäº Ïä§ÌÉÄÏùº Ï¥àÍ∏∞Ìôî
                    document.querySelectorAll('.btn-group button').forEach(b => {
                        b.classList.remove('btn-primary');
                        b.style.color = ''; // Í∏∞Î≥∏ÏÉâ
                    });

                    btn.classList.add('btn-primary');
                    btn.style.color = 'white';

                    const type = btn.getAttribute('data-type');
                    loadStatistics(type);
                });
            });
        });
        // üî∑ ÎÇ†Ïßú ÏÑ†ÌÉùÏãúÏóêÎèÑ Ïû¨Ï°∞Ìöå
        document.getElementById('startDate').addEventListener('change', () => {
            loadStatistics(getCurrentType());
        });
        document.getElementById('endDate').addEventListener('change', () => {
            loadStatistics(getCurrentType());
        });

        function getCurrentType() {
            const activeBtn = document.querySelector('.btn-group .btn-primary');
            return activeBtn ? activeBtn.getAttribute('data-type') : 'month';
        }

    </script>

</main>
</body>
</html>
