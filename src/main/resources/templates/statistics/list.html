<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>통계</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background-color: #f8f9fa; }

        /* 카드 레이아웃 (데스크톱: 좌우 / 모바일: 상하) */
        .fixed-height-container { display: flex; flex-wrap: wrap; }
        .fixed-height-container .card { flex: 1; display: flex; flex-direction: column; }
        .scrollable-body { overflow-y: auto; min-height: 0; }

        #salesChart {
            width: 100% !important;
            height: 300px !important;
        }

        .date-group { display: flex; align-items: center; gap: 10px; }
        .date-label { white-space: nowrap; }

        .date-inputs { display: flex; align-items: center; gap: 5px; }

        /* 모바일 */
        @media (max-width: 768px) {
            .fixed-height-container { flex-direction: column; }
            #salesChart { height: 220px !important; }
            .p-3.mb-3.bg-light.rounded.border.d-flex {
                flex-direction: column;
                gap: 10px;
            }
            .date-group { flex-direction: column; align-items: flex-start; }
            .date-label { margin-bottom: 5px; }
        }
    </style>
</head>
<body>
<main layout:fragment="content">
    <div class="container">
        <h4 class="fw-bold mb-4"><i class="bi bi-graph-up-arrow text-primary me-2"></i> 통계</h4>

        <p class="mb-4 fw-bold" th:text="${today} + ' 기준 매출현황입니다.'">
            <i class="bi bi-calendar-event me-2 text-secondary"></i> yyyy년 MM월 dd일
        </p>

        <!-- 요약 카드 -->
        <div class="row g-3 mb-4 p-3 rounded" style="background:#e6f7ff">
            <div class="col-md-4 col-12">
                <div class="card shadow-sm text-dark">
                    <div class="card-body">
                        <h6 class="card-title text-muted"><i class="bi bi-cash-stack me-2 text-success"></i>총 매출</h6>
                        <h5 class="fw-bold text-end" th:text="${#numbers.formatInteger(sales.totalSales, 0,'COMMA')} + '원'">0원</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-12">
                <div class="card shadow-sm text-dark">
                    <div class="card-body">
                        <h6 class="card-title text-muted"><i class="bi bi-calendar3 me-2 text-primary"></i>월 매출</h6>
                        <h5 class="fw-bold text-end" th:text="${#numbers.formatInteger(sales.monthlySales, 0,'COMMA')} + '원'">0원</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-12">
                <div class="card shadow-sm text-dark">
                    <div class="card-body">
                        <h6 class="card-title text-muted"><i class="bi bi-clock-history me-2 text-danger"></i>일 매출</h6>
                        <h5 class="fw-bold text-end" th:text="${#numbers.formatInteger(sales.dailySales, 0,'COMMA')} + '원'">0원</h5>
                    </div>
                </div>
            </div>
        </div>

        <!-- 기간 조회 -->
        <div class="p-3 mb-3 bg-light rounded border d-flex align-items-center justify-content-between">
            <div class="date-group">
                <label for="startDate" class="fw-bold date-label"><i class="bi bi-calendar-range me-2 text-info"></i>기간조회</label>
                <div class="date-inputs">
                    <input type="date" class="form-control form-control-sm w-auto" id="startDate">
                    <span>~</span>
                    <input type="date" class="form-control form-control-sm w-auto" id="endDate">
                </div>
            </div>

            <div class="btn-group w-auto" role="group">
                <button class="btn btn-outline-secondary px-4 py-2" data-type="year"><i class="bi bi-calendar4 me-1"></i>년</button>
                <button class="btn btn-outline-secondary px-4 py-2" data-type="month"><i class="bi bi-calendar2-month me-1"></i>월</button>
                <button class="btn btn-outline-secondary px-4 py-2" data-type="day"><i class="bi bi-calendar2-day me-1"></i>일</button>
            </div>
        </div>

        <!-- 차트 -->
        <div class="m-4">
            <canvas id="salesChart"></canvas>
        </div>

        <!-- 통계 카드 -->
        <div class="row mt-4 fixed-height-container">
            <div class="col-md-5 col-12 mb-3 mb-md-0">
                <div class="card shadow-sm" id="leftCard">
                    <div class="card-header fw-bold text-center"><i class="bi bi-bar-chart-line-fill me-2 text-primary"></i> 매출 통계 요약</div>
                    <div class="card-body" id="statisticsCardBody"></div>
                </div>
            </div>
            <div class="col-md-7 col-12">
                <div class="card shadow-sm" id="rightCard">
                    <div class="card-header fw-bold text-center"><i class="bi bi-list-ul me-2 text-success"></i> 요약 정보</div>
                    <div class="card-body scrollable-body" id="rightCardBody">
                        <!-- 데스크톱 테이블 -->
                        <div class="d-none d-md-block">
                            <div class="table-responsive">
                                <table class="table table-bordered text-center align-middle mb-0">
                                    <thead class="table-light">
                                    <tr>
                                        <th><i class="bi bi-person me-1"></i>회원명</th>
                                        <th><i class="bi bi-box-seam me-1"></i>상품명</th>
                                        <th><i class="bi bi-calendar-check me-1"></i>일자</th>
                                        <th><i class="bi bi-cash me-1"></i>금액</th>
                                    </tr>
                                    </thead>
                                    <tbody id="detailTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- 모바일 카드 -->
                        <div class="d-block d-md-none">
                            <div id="detailCardBody" class="d-flex flex-column gap-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ JS: 매출 통계 -->
    <script>
        let chart = null;

        function renderChart(labels, salesData) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '총 매출',
                        data: salesData,
                        backgroundColor: 'rgba(21, 162, 235, 0.5)',
                        borderColor: 'rgba(21, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderCombinedStatistics(data) {
            const ptRows = data.ptMembers.map(m => `
                <tr class="clickable-row" data-category="PT" data-name="${m.productName}">
                    ${Object.values(m).map(v => `<td>${typeof v === 'number' ? v.toLocaleString('ko-KR') : v}</td>`).join('')}
                </tr>`).join('');

            const membershipRows = data.membershipMembers.map(m => `
                <tr class="clickable-row" data-category="MEMBERSHIP" data-name="${m.productName}">
                    ${Object.values(m).map(v => `<td>${typeof v === 'number' ? v.toLocaleString('ko-KR') : v}</td>`).join('')}
                </tr>`).join('');

            document.getElementById("statisticsCardBody").innerHTML = `
                <h6 class="fw-bold">📌 PT 통계</h6><hr>
                <div class="table-responsive mb-3" style="max-height:300px;overflow-y:auto;">
                    <table class="table table-bordered text-center align-middle mb-0 table-hover">
                        <thead class="table-light"><tr><th>상품명</th><th>건수</th><th>금액</th><th>총 금액</th></tr></thead>
                        <tbody>${ptRows}</tbody>
                    </table>
                </div>
                <div class="bg-primary text-white text-center py-2 rounded mb-4">
                    총합: <span>${data.ptSummary.totalAmount.toLocaleString()}원</span> / 총 건수: <span>${data.ptSummary.count}개</span>
                </div>

                <h6 class="fw-bold">📌 회원권 통계</h6><hr>
                <div class="table-responsive mb-3" style="max-height:300px;overflow-y:auto;">
                    <table class="table table-bordered text-center align-middle mb-0 table-hover">
                        <thead class="table-light"><tr><th>상품명</th><th>건수</th><th>금액</th><th>총 금액</th></tr></thead>
                        <tbody>${membershipRows}</tbody>
                    </table>
                </div>
                <div class="bg-success text-white text-center py-2 rounded">
                    총합: <span>${data.membershipSummary.totalAmount.toLocaleString()}원</span> / 총 건수: <span>${data.membershipSummary.count}개</span>
                </div>
            `;

            document.querySelectorAll('.clickable-row').forEach(row => {
                row.addEventListener('click', () => {
                    document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('table-primary'));
                    row.classList.add('table-primary');
                    loadDetailSummary(row.dataset.category, row.dataset.name);
                });
            });

            adjustRightCardHeight();
        }

        function loadDetailSummary(category, productName) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            axios.get('/statistics/detail', { params: { category, name: productName, start: startDate, end: endDate } })
                .then(response => {
                    const tbody = document.getElementById('detailTableBody');
                    tbody.innerHTML = '';
                    const container = document.getElementById('detailCardBody');
                    container.innerHTML = '';

                    response.data.forEach(detail => {
                        tbody.innerHTML += `
                            <tr><td>${detail.memberName}</td><td>${detail.productName}</td><td>${detail.date}</td><td>${detail.amount.toLocaleString('ko-KR')}원</td></tr>`;
                        container.innerHTML += `
                            <div class="card shadow-sm p-2"><div class="card-body">
                                <h6 class="fw-bold mb-2">${detail.memberName}</h6>
                                <p class="mb-1 text-muted">상품명: ${detail.productName}</p>
                                <p class="mb-1 text-muted">일자: ${detail.date}</p>
                                <p class="mb-0 text-muted">금액: ${detail.amount.toLocaleString('ko-KR')}원</p>
                            </div></div>`;
                    });
                })
                .catch(() => alert("세부 정보를 불러오는 중 문제가 발생했습니다."));
        }

        function fillMissingDates(startDateStr, endDateStr, labels, salesData, type) {
            const resultMap = {}; labels.forEach((l, i) => resultMap[l] = salesData[i]);
            const completeLabels = [], completeSales = [];
            const start = new Date(startDateStr), end = new Date(endDateStr), current = new Date(start), endCheck = new Date(end);

            if (type === 'month') { current.setDate(1); endCheck.setDate(1); }
            if (type === 'year') { current.setMonth(0); current.setDate(1); endCheck.setMonth(0); endCheck.setDate(1); }

            while (current <= endCheck) {
                let label;
                if (type === 'year') { label = current.getFullYear().toString(); current.setFullYear(current.getFullYear() + 1); }
                else if (type === 'month') { label = `${current.getFullYear()}-${String(current.getMonth()+1).padStart(2,'0')}`; current.setMonth(current.getMonth()+1); }
                else { label = current.toISOString().slice(0,10); current.setDate(current.getDate()+1); }

                completeLabels.push(label);
                completeSales.push(resultMap[label] ?? 0);
            }
            return { labels: completeLabels, salesData: completeSales };
        }

        function loadStatistics(type) {
            const startDate = document.getElementById('startDate').value, endDate = document.getElementById('endDate').value;
            if (!startDate || !endDate) { alert("조회할 날짜를 모두 선택하세요."); return; }

            axios.get('/statistics/api', { params: { start: startDate, end: endDate, type: type } })
                .then(response => {
                    const data = response.data;
                    const completed = fillMissingDates(startDate, endDate, data.labels, data.salesData, type);
                    renderChart(completed.labels, completed.salesData);
                    renderCombinedStatistics(data);
                })
                .catch(() => alert("데이터를 불러오는 중 문제가 발생했습니다."));
        }

        document.addEventListener("DOMContentLoaded", () => {
            const today = new Date(), endDateStr = today.toISOString().split('T')[0];
            const sixMonthsAgo = new Date(today); sixMonthsAgo.setMonth(sixMonthsAgo.getMonth()-5); sixMonthsAgo.setDate(1);
            document.getElementById('startDate').value = sixMonthsAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDateStr;

            const monthBtn = document.querySelector('.btn-group button[data-type="month"]');
            if (monthBtn) { monthBtn.classList.add('btn-primary'); monthBtn.style.color = 'white'; }

            loadStatistics("month");

            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.btn-group button').forEach(b => { b.classList.remove('btn-primary'); b.style.color = ''; });
                    btn.classList.add('btn-primary'); btn.style.color = 'white';
                    loadStatistics(btn.getAttribute('data-type'));
                });
            });

            document.getElementById('startDate').addEventListener('change', () => loadStatistics(getCurrentType()));
            document.getElementById('endDate').addEventListener('change', () => loadStatistics(getCurrentType()));
        });

        function getCurrentType() {
            const activeBtn = document.querySelector('.btn-group .btn-primary');
            return activeBtn ? activeBtn.getAttribute('data-type') : 'month';
        }

        function adjustRightCardHeight() {
            const leftCard = document.getElementById('leftCard'), rightCard = document.getElementById('rightCard'), rightCardBody = document.getElementById('rightCardBody');
            if (!leftCard || !rightCard || !rightCardBody) return;
            const leftHeight = leftCard.offsetHeight;
            rightCard.style.height = `${leftHeight}px`;
            const headerHeight = rightCard.querySelector('.card-header').offsetHeight;
            rightCardBody.style.height = `${leftHeight - headerHeight}px`;
        }

        window.addEventListener('load', adjustRightCardHeight);
        window.addEventListener('resize', adjustRightCardHeight);
    </script>
</main>
</body>
</html>
