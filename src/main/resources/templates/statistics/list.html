<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>í†µê³„</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .clickable-row {
            cursor: pointer;
        }
        .clickable-row:hover {
            background-color: #f8f9fa;
        }

        /* ì¹´ë“œ ë ˆì´ì•„ì›ƒ (ë°ìŠ¤í¬í†±: ì¢Œìš° / ëª¨ë°”ì¼: ìƒí•˜) */
        .fixed-height-container {
            display: flex;
            flex-wrap: wrap;
        }
        .fixed-height-container .card {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .scrollable-body {
            overflow-y: auto;
            min-height: 0;
        }

        #salesChart {
            width: 100% !important;
            height: 300px !important; /* ì›í•˜ëŠ” ë†’ì´ (ì˜ˆ: 250px) */
        }

        /* ê¸°ë³¸(ë°ìŠ¤í¬í†±): ê°€ë¡œ ë°°ì¹˜ */
        .date-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-label {
            white-space: nowrap;
        }

        /* ë‚ ì§œ input ê°€ë¡œ ë°°ì¹˜ */
        .date-inputs {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            .fixed-height-container {
                flex-direction: column;  /* ëª¨ë°”ì¼ì—ì„œëŠ” ì„¸ë¡œ ë°°ì¹˜ */
            }
            #salesChart {
                height: 220px !important; /* ëª¨ë°”ì¼ì—ì„œ ì¡°ê¸ˆ ë” ì‘ê²Œ */
            }
            .p-3.mb-3.bg-light.rounded.border.d-flex {
                flex-direction: column; /* ê¸°ê°„ì¡°íšŒ + ë²„íŠ¼ ì„¸ë¡œ ë°°ì¹˜ */
                gap: 10px;
            }
            /* ë¼ë²¨ë§Œ ìœ„ë¡œ */
            .date-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .date-label {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
<main layout:fragment="content">
    <div class="container">
        <h4 class="fw-bold mb-4">í†µê³„</h4>

        <p class="mb-4 fw-bold" th:text="${today} + ' ê¸°ì¤€ ë§¤ì¶œí˜„í™©ì…ë‹ˆë‹¤.'">
            yyyyë…„ MMì›” ddì¼
        </p>

        <!-- ìš”ì•½ ì¹´ë“œ (ë°ìŠ¤í¬í†±: ê°€ë¡œ 3ë“±ë¶„, ëª¨ë°”ì¼: ì„¸ë¡œ) -->
        <div class="row g-3 mb-4 p-3 rounded" style="background:#e6f7ff">
            <div class="col-md-4 col-12">
                <div class="card shadow-sm text-dark">
                    <div class="card-body">
                        <h6 class="card-title text-muted">ì´ ë§¤ì¶œ</h6>
                        <h5 class="fw-bold text-end" th:text="${#numbers.formatInteger(sales.totalSales, 0,'COMMA')} + 'ì›'">334,197,202ì›</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-12">
                <div class="card shadow-sm text-dark">
                    <div class="card-body">
                        <h6 class="card-title text-muted">ì›” ë§¤ì¶œ</h6>
                        <h5 class="fw-bold text-end" th:text="${#numbers.formatInteger(sales.monthlySales, 0,'COMMA')} + 'ì›'">11,924,500ì›</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-12">
                <div class="card shadow-sm text-dark">
                    <div class="card-body">
                        <h6 class="card-title text-muted">ì¼ ë§¤ì¶œ</h6>
                        <h5 class="fw-bold text-end" th:text="${#numbers.formatInteger(sales.dailySales, 0,'COMMA')} + 'ì›'">0ì›</h5>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-3 mb-3 bg-light rounded border d-flex align-items-center justify-content-between">

            <!-- ë‚ ì§œ ê·¸ë£¹ -->
            <div class="date-group">
                <label for="startDate" class="fw-bold date-label">ê¸°ê°„ì¡°íšŒ</label>
                <div class="date-inputs">
                    <input type="date" class="form-control form-control-sm w-auto" id="startDate">
                    <span>~</span>
                    <input type="date" class="form-control form-control-sm w-auto" id="endDate">
                </div>
            </div>

            <!-- ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="btn-group w-auto" role="group">
                <button class="btn btn-outline-secondary px-4 py-2" data-type="year">ë…„</button>
                <button class="btn btn-outline-secondary px-4 py-2" data-type="month">ì›”</button>
                <button class="btn btn-outline-secondary px-4 py-2" data-type="day">ì¼</button>
            </div>
        </div>

        <!-- ì°¨íŠ¸ -->
        <div class="m-4">
            <canvas id="salesChart"></canvas>
        </div>

        <!-- í†µê³„ ì¹´ë“œ (ë°ìŠ¤í¬í†±: ì¢Œìš° / ëª¨ë°”ì¼: ìƒí•˜) -->
        <div class="row mt-4 fixed-height-container">
            <!-- ì™¼ìª½ ì¹´ë“œ -->
            <div class="col-md-5 col-12 mb-3 mb-md-0">
                <div class="card shadow-sm" id="leftCard">
                    <div class="card-header fw-bold text-center">ğŸ“Š ë§¤ì¶œ í†µê³„ ìš”ì•½</div>
                    <div class="card-body" id="statisticsCardBody"></div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½ ì¹´ë“œ -->
            <div class="col-md-7 col-12">
                <div class="card shadow-sm" id="rightCard">
                    <div class="card-header fw-bold text-center">ğŸ¯ ìš”ì•½ ì •ë³´</div>
                    <div class="card-body scrollable-body" id="rightCardBody">

                        <!-- ğŸ–¥ï¸ ë°ìŠ¤í¬í†±ìš©: í…Œì´ë¸” -->
                        <div class="d-none d-md-block">
                            <div class="table-responsive">
                                <table class="table table-bordered text-center align-middle mb-0">
                                    <thead class="table-light">
                                    <tr>
                                        <th>íšŒì›ëª…</th>
                                        <th>ìƒí’ˆëª…</th>
                                        <th>ì¼ì</th>
                                        <th>ê¸ˆì•¡</th>
                                    </tr>
                                    </thead>
                                    <tbody id="detailTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- ğŸ“± ëª¨ë°”ì¼ìš©: ì¹´ë“œ -->
                        <div class="d-block d-md-none">
                            <div id="detailCardBody" class="d-flex flex-column gap-3">
                                <!-- JSì—ì„œ ì¹´ë“œ ì¶”ê°€ -->
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let chart = null;

        // ğŸ”¹ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        function renderChart(labels, salesData) {
            console.log(labels); // ë°°ì—´ì´ì–´ì•¼ í•¨
            console.log(salesData); // ë°°ì—´ì´ì–´ì•¼ í•¨

            const ctx = document.getElementById('salesChart').getContext('2d');
            if (chart) chart.destroy(); // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: ['ì´ ë§¤ì¶œ'],
                        data: salesData,
                        backgroundColor: ['rgba(21, 162, 235, 0.5)'],
                        borderColor: ['rgba(21, 162, 235, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderCombinedStatistics(data) {
            const ptRows = data.ptMembers.map(m => `
        <tr class="clickable-row" data-category="PT" data-name="${m.productName}">
            ${Object.values(m).map(v => `<td>${typeof v === 'number' ? v.toLocaleString('ko-KR') : v}</td>`).join('')}
        </tr>`).join('');

            const membershipRows = data.membershipMembers.map(m => `
        <tr class="clickable-row" data-category="MEMBERSHIP" data-name="${m.productName}">
            ${Object.values(m).map(v => `<td>${typeof v === 'number' ? v.toLocaleString('ko-KR') : v}</td>`).join('')}
        </tr>`).join('');

            document.getElementById("statisticsCardBody").innerHTML = `
    <h6 class="fw-bold">ğŸ“Œ PT í†µê³„</h6>
    <hr>
    <div class="table-responsive mb-3" style="max-height: 300px; overflow-y: auto;">
        <table class="table table-bordered text-center align-middle mb-0 table-hover">
            <thead class="table-light">
                <tr><th>ìƒí’ˆëª…</th><th>ê±´ìˆ˜</th><th>ê¸ˆì•¡</th><th>ì´ ê¸ˆì•¡</th></tr>
            </thead>
            <tbody>${ptRows}</tbody>
        </table>
    </div>
    <div class="bg-primary text-white text-center py-2 rounded mb-4">
        ì´í•©: <span>${data.ptSummary.totalAmount.toLocaleString()}ì›</span> / ì´ ê±´ìˆ˜: <span>${data.ptSummary.count}ê°œ</span>
    </div>

    <h6 class="fw-bold">ğŸ“Œ íšŒì›ê¶Œ í†µê³„</h6>
    <hr>
    <div class="table-responsive mb-3" style="max-height: 300px; overflow-y: auto;">
        <table class="table table-bordered text-center align-middle mb-0 table-hover">
            <thead class="table-light">
                <tr><th>ìƒí’ˆëª…</th><th>ê±´ìˆ˜</th><th>ê¸ˆì•¡</th><th>ì´ ê¸ˆì•¡</th></tr>
            </thead>
            <tbody>${membershipRows}</tbody>
        </table>
    </div>
    <div class="bg-success text-white text-center py-2 rounded">
        ì´í•©: <span>${data.membershipSummary.totalAmount.toLocaleString()}ì›</span> / ì´ ê±´ìˆ˜: <span>${data.membershipSummary.count}ê°œ</span>
    </div>
    `;

            // âœ… ë™ì ìœ¼ë¡œ ìƒì„±ëœ í–‰ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
            document.querySelectorAll('.clickable-row').forEach(row => {
                row.addEventListener('click', () => {
                    // âœ… ëª¨ë“  í–‰ì—ì„œ ì„ íƒ í´ë˜ìŠ¤ ì œê±°
                    document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('table-primary'));

                    // âœ… í´ë¦­í•œ í–‰ë§Œ ê°•ì¡°
                    row.classList.add('table-primary');

                    const category = row.dataset.category;
                    const productName = row.dataset.name;
                    loadDetailSummary(category, productName);
                });
            });

            // âœ… ì´ ì¤„ ì¶”ê°€!
            adjustRightCardHeight();
        }


        function loadDetailSummary(category, productName) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            axios.get('/statistics/detail', {
                params: { category, name: productName, start: startDate, end: endDate }
            }).then(response => {
                // ğŸ–¥ï¸ í…Œì´ë¸” ë°ì´í„° ë°˜ì˜
                const tbody = document.getElementById('detailTableBody');
                tbody.innerHTML = '';

                // ğŸ“± ì¹´ë“œ ë°ì´í„° ë°˜ì˜
                const container = document.getElementById('detailCardBody');
                container.innerHTML = '';

                response.data.forEach(detail => {
                    // í…Œì´ë¸” í–‰ ì¶”ê°€
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${detail.memberName}</td>
                <td>${detail.productName}</td>
                <td>${detail.date}</td>
                <td>${detail.amount.toLocaleString('ko-KR')}ì›</td>
            `;
                    tbody.appendChild(row);

                    // ì¹´ë“œ ì¶”ê°€
                    const card = document.createElement('div');
                    card.classList.add('card', 'shadow-sm', 'p-2');
                    card.innerHTML = `
                <div class="card-body">
                    <h6 class="card-title fw-bold mb-2">${detail.memberName}</h6>
                    <p class="mb-1"><span class="text-muted">ìƒí’ˆëª…:</span> ${detail.productName}</p>
                    <p class="mb-1"><span class="text-muted">ì¼ì:</span> ${detail.date}</p>
                    <p class="mb-0"><span class="text-muted">ê¸ˆì•¡:</span> ${detail.amount.toLocaleString('ko-KR')}ì›</p>
                </div>
            `;
                    container.appendChild(card);
                });
            }).catch(error => {
                console.error("âŒ ì„¸ë¶€ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                alert("ì„¸ë¶€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        }

        function fillMissingDates(startDateStr, endDateStr, labels, salesData, type) {
            const resultMap = {};
            for (let i = 0; i < labels.length; i++) {
                resultMap[labels[i]] = salesData[i];
            }

            const completeLabels = [];
            const completeSales = [];

            const start = new Date(startDateStr);
            const end = new Date(endDateStr);

            const current = new Date(start);
            const endCheck = new Date(end);

            if (type === 'month') {
                current.setDate(1);
                endCheck.setDate(1);
            }
            if (type === 'year') {
                current.setMonth(0);
                current.setDate(1);
                endCheck.setMonth(0);
                endCheck.setDate(1);
            }

            while (current <= endCheck) {
                let label;

                if (type === 'year') {
                    label = current.getFullYear().toString();
                    current.setFullYear(current.getFullYear() + 1);
                } else if (type === 'month') {
                    label = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`;
                    current.setMonth(current.getMonth() + 1);
                } else {
                    label = current.toISOString().slice(0, 10);
                    current.setDate(current.getDate() + 1);
                }

                completeLabels.push(label);
                completeSales.push(resultMap[label] ?? 0);
            }

            return {
                labels: completeLabels,
                salesData: completeSales
            };
        }


        // ğŸ”¹ í†µê³„ ë¡œë”©
        function loadStatistics(type) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert("ì¡°íšŒí•  ë‚ ì§œë¥¼ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.");
                return;
            }

            axios.get('/statistics/api', {
                params: {
                    start: startDate,
                    end: endDate,
                    type: type
                }
            })
                .then(response => {
                    const data = response.data;

                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    const completed = fillMissingDates(startDate, endDate, data.labels, data.salesData, type);

                    renderChart(completed.labels, completed.salesData);

                    renderCombinedStatistics(data);

                })
                .catch(error => {
                    console.error('âŒ í†µê³„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
        }

        document.addEventListener("DOMContentLoaded", function () {
            // ğŸ”· ì˜¤ëŠ˜ê³¼ 6ê°œì›” ì „ ë‚ ì§œ ê³„ì‚°
            const today = new Date();
            const endDateStr = today.toISOString().split('T')[0];

            const sixMonthsAgo = new Date(today);
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 5);
            sixMonthsAgo.setDate(1); // í•´ë‹¹ ë‹¬ì˜ 1ì¼
            // ğŸ”· inputì— ì´ˆê¸°ê°’ ì„¸íŒ…
            document.getElementById('startDate').value = sixMonthsAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDateStr;

            // ğŸ”· ë²„íŠ¼ ì¤‘ 'ì›”' ë²„íŠ¼ì„ active ì²˜ë¦¬
            const monthBtn = document.querySelector('.btn-group button[data-type="month"]');
            if (monthBtn) {
                monthBtn.classList.add('btn-primary');
                monthBtn.style.color = 'white';
            }

            // ğŸ”· ì´ˆê¸° ë¡œë“œ
            loadStatistics("month");

            // ğŸ”· ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.addEventListener('click', () => {
                    // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                    document.querySelectorAll('.btn-group button').forEach(b => {
                        b.classList.remove('btn-primary');
                        b.style.color = ''; // ê¸°ë³¸ìƒ‰
                    });

                    btn.classList.add('btn-primary');
                    btn.style.color = 'white';

                    const type = btn.getAttribute('data-type');
                    loadStatistics(type);
                });
            });
        });

        // ğŸ”· ë‚ ì§œ ì„ íƒì‹œì—ë„ ì¬ì¡°íšŒ
        document.getElementById('startDate').addEventListener('change', () => {
            loadStatistics(getCurrentType());
        });
        document.getElementById('endDate').addEventListener('change', () => {
            loadStatistics(getCurrentType());
        });

        function getCurrentType() {
            const activeBtn = document.querySelector('.btn-group .btn-primary');
            return activeBtn ? activeBtn.getAttribute('data-type') : 'month';
        }

        // í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        document.querySelectorAll('.clickable-row').forEach(row => {
            row.addEventListener('click', () => {
                const category = row.dataset.category;
                const productName = row.dataset.name;
                loadDetailSummary(category, productName);
            });
        });

        function adjustRightCardHeight() {
            const leftCard = document.getElementById('leftCard');
            const rightCard = document.getElementById('rightCard');
            const rightCardBody = document.getElementById('rightCardBody');

            if (!leftCard || !rightCard || !rightCardBody) return;

            const leftHeight = leftCard.offsetHeight;
            rightCard.style.height = `${leftHeight}px`;

            const headerHeight = rightCard.querySelector('.card-header').offsetHeight;
            rightCardBody.style.height = `${leftHeight - headerHeight}px`;
        }

        // í˜ì´ì§€ ë¡œë“œ ë° ë¦¬ì‚¬ì´ì¦ˆ, í†µê³„ ì¬ë¡œë”© í›„ í˜¸ì¶œ
        window.addEventListener('load', adjustRightCardHeight);
        window.addEventListener('resize', adjustRightCardHeight);


    </script>

</main>
</body>
</html>
