<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>ìˆ˜ì—… ë“±ë¡</title>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <style>
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background-color: #f8f9fa; }

        /* ì™¼ìª½ ì¹´ë“œ ì˜ì—­ */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: 800px;
        }
        .left-column .card {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .left-column .card-body.scroll-table {
            flex: 1;
            overflow-y: auto;
        }

        /* ì˜¤ë¥¸ìª½ ë‹¬ë ¥ ì˜ì—­ */
        .calendar-container {
            min-height: 700px;
            display: flex;
            flex-direction: column;
        }
        .calendar-box {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* daterangepickerë¥¼ ì¹´ë“œ ì•ˆì— ê½‰ ì±„ìš°ê¸° */
        #calendarInline .daterangepicker {
            position: static !important;
            transform: none !important;
            box-shadow: none !important;
            width: 100% !important;
            height: 100% !important;
            border: none;
        }

        /* ë‚ ì§œ ë²„íŠ¼ í¬ê¸° í‚¤ìš°ê¸° */
        #calendarInline .daterangepicker td,
        #calendarInline .daterangepicker th {
            padding: 12px 14px;
            font-size: 18px;
        }

        #calendarInline .daterangepicker .drp-calendar.left {
            margin-right: 100px !important; /* ê¸°ë³¸ì€ 20px */
        }
        #calendarInline .daterangepicker .drp-buttons {
            display: none !important;
        }

        .time-btn {
            min-width:80px;
            height: 40px;
            font-size: 14px;
            text-align: center;
        }
        .member-row.selected { background-color: #e7f1ff; }
        .dow-disabled { opacity: .5; }

        .member-row.selected {
            background-color: #e7f1ff; /* ì„ íƒ íš¨ê³¼ */
        }
    </style>
</head>

<main layout:fragment="content">
    <div class="container">
        <h4 class="fw-bold mb-4">ìˆ˜ì—… ë“±ë¡</h4>

        <div class="row">
            <!-- ì™¼ìª½ ì˜ì—­ (ê·¸ëŒ€ë¡œ) -->
            <div class="col-12 col-md-5">
                <div class="left-column">
                    <!-- íŠ¸ë ˆì´ë„ˆ ëª©ë¡ ì¹´ë“œ -->
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="text-black fw-bold">ê°•ì‚¬ ëª©ë¡</span>
                        </div>
                        <div class="card-body scroll-table">
                            <table class="table table-striped table-hover text-center align-middle">
                                <thead class="table-light">
                                <tr>
                                    <th>ì´ë¦„</th>
                                    <th>ì„±ë³„</th>
                                    <th>ìƒì¼</th>
                                    <th>ê²½ë ¥(ë…„)</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="pt : ${trainers}"
                                    th:attr="data-href=@{'/lecture/' + ${pt.trainerId}}"
                                    th:classappend="${selectedTrainerId == pt.trainerId} ? 'table-primary'"
                                    class="clickable-row">
                                    <td th:text="${pt.name}"></td>
                                    <td th:text="${pt.gender}"></td>
                                    <td th:text="${#temporals.format(pt.birthDate, 'yyyy-MM-dd')}"></td>
                                    <td th:text="${pt.careerYears} + 'ë…„'"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- í•´ë‹¹ íŠ¸ë ˆì´ë„ˆ íšŒì› ëª©ë¡ ì¹´ë“œ -->
                    <div class="card shadow-sm">
                        <div class="card-header fw-bold">
                            <span th:if="${selectedTrainerId != null}">ê°•ì‚¬ íšŒì› ëª©ë¡</span>
                            <span th:if="${selectedTrainerId == null}" class="text-muted">ê°•ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</span>
                        </div>
                        <div class="card-body scroll-table d-none d-md-block">
                            <table class="table table-striped table-hover text-center align-middle"
                                   th:if="${ptMembers != null and !ptMembers.isEmpty()}">
                                <thead class="table-light">
                                <tr>
                                    <th>ì´ë¦„</th>
                                    <th>ë‚¨ì€ íšŸìˆ˜</th>
                                    <th>ì´ íšŸìˆ˜</th>
                                    <th>ì‹œì‘ì¼</th>
                                    <th>ì¢…ë£Œì¼</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="pm : ${ptMembers}"
                                    class="member-row"
                                    th:attr="data-member-id=${pm.memberId},
                                                data-package-id=${pm.packageId},
                                                data-remaining=${pm.remainingCount},
                                                data-start=${#temporals.format(pm.startDate, 'yyyy-MM-dd')},
                                                data-end=${#temporals.format(pm.endDate, 'yyyy-MM-dd')}">
                                    <td th:text="${pm.name}"></td>
                                    <td th:text="${pm.remainingCount}"></td>
                                    <td th:text="${pm.totalCount}"></td>
                                    <td th:text="${#temporals.format(pm.startDate, 'yyyy-MM-dd')}"></td>
                                    <td th:text="${#temporals.format(pm.endDate, 'yyyy-MM-dd')}"></td>
                                </tr>
                                </tbody>
                            </table>
                            <p class="text-muted" th:if="${ptMembers == null or ptMembers.isEmpty()}">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>

                        <!-- ëª¨ë°”ì¼ ì¹´ë“œ ë·° -->
                        <div class="d-md-none">
                            <div th:if="${ptMembers != null and !ptMembers.isEmpty()}">
                                <div th:each="pm : ${ptMembers}"
                                     class="card mb-2 shadow-sm member-row"
                                     th:attr="data-member-id=${pm.memberId},
                                              data-package-id=${pm.packageId},
                                              data-remaining=${pm.remainingCount},
                                              data-start=${#temporals.format(pm.startDate, 'yyyy-MM-dd')},
                                              data-end=${#temporals.format(pm.endDate, 'yyyy-MM-dd')}">
                                    <div class="card-body p-2">
                                        <!-- ì´ë¦„ + ì”ì—¬íšŸìˆ˜ -->
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="fw-bold" th:text="${pm.name}">í™ê¸¸ë™</span>
                                            <span class="badge bg-primary"
                                                  th:text="'ì”ì—¬ ' + ${pm.remainingCount} + 'íšŒ'">ì”ì—¬ 10íšŒ</span>
                                        </div>

                                        <!-- ì´ íšŸìˆ˜ -->
                                        <div class="mb-1 small text-muted">
                                            ì´ <span th:text="${pm.totalCount}">30</span> íšŒ
                                        </div>

                                        <!-- ê¸°ê°„ -->
                                        <div class="small">
                                            <span th:text="${#temporals.format(pm.startDate, 'yyyy-MM-dd')}">2025-08-01</span>
                                            ~
                                            <span th:text="${#temporals.format(pm.endDate, 'yyyy-MM-dd')}">2025-12-01</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="text-muted" th:if="${ptMembers == null or ptMembers.isEmpty()}">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½ ì˜ì—­ -->
            <div class="col-12 col-md-7">
                <form>
                    <div class="calendar-container">
                        <!-- ê¸°ê°„ ì„ íƒ -->
                        <div class="card shadow-sm mb-2 calendar-box" style="height: 700px;">
                            <div class="card-header fw-bold d-flex align-items-center justify-content-between flex-wrap gap-2">
                                <span>ê¸°ê°„ ì„ íƒ</span>
                            </div>
                            <div class="card-body p-2">
                                <!-- ì•ˆë‚´ ë¬¸êµ¬: ì´ˆê¸° í‘œì‹œ -->
                                <div id="calendarPlaceholder"
                                     class="d-flex align-items-center justify-content-center border rounded h-100 text-muted"
                                     style="min-height: 360px;">
                                    íšŒì›ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”
                                </div>

                                <!-- ì‹¤ì œ ë‹¬ë ¥ ì˜ì—­: ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ -->
                                <div id="calendarArea" class="d-none">
                                    <input type="text" id="selectedRange" class="form-control mb-2" readonly>
                                    <div id="calendarInline" style="width: 100%; height: 100%;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- ìš”ì¼ ì„ íƒ -->
                        <div class="card shadow-sm mb-2">
                            <div class="card-header fw-bold d-flex align-items-center justify-content-between flex-wrap gap-2">
                                <span>ìš”ì¼ ì„ íƒ (ë°˜ë³µ)</span>
                                <!-- ì„ íƒëœ íŠ¸ë ˆì´ë„ˆ ID ë³´ê´€ -->
                                <div id="pageMeta" th:attr="data-trainer-id=${selectedTrainerId}"></div>

                                <div class="d-flex align-items-center flex-wrap gap-3">
                                    <label class="form-check-label">
                                        <input type="checkbox" class="form-check-input" name="dayOfWeek" value="ì›”"> ì›”
                                    </label>
                                    <label class="form-check-label">
                                        <input type="checkbox" class="form-check-input" name="dayOfWeek" value="í™”"> í™”
                                    </label>
                                    <label class="form-check-label">
                                        <input type="checkbox" class="form-check-input" name="dayOfWeek" value="ìˆ˜"> ìˆ˜
                                    </label>
                                    <label class="form-check-label">
                                        <input type="checkbox" class="form-check-input" name="dayOfWeek" value="ëª©"> ëª©
                                    </label>
                                    <label class="form-check-label">
                                        <input type="checkbox" class="form-check-input" name="dayOfWeek" value="ê¸ˆ"> ê¸ˆ
                                    </label>
                                    <label class="form-check-label">
                                        <input type="checkbox" class="form-check-input" name="dayOfWeek" value="í† "> í† 
                                    </label>
                                    <label class="form-check-label">
                                        <input type="checkbox" class="form-check-input" name="dayOfWeek" value="ì¼"> ì¼
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- ì‹œê°„ ì„ íƒ -->
                        <div class="card shadow-sm">
                            <div class="card-header fw-bold d-flex align-items-center justify-content-between flex-wrap gap-1">
                                <span>ì‹œê°„ ì„ íƒ</span>
                            </div>
                            <div class="card-body">
                                <!-- ì˜¤ì „ -->
                                <div class="mb-3">
                                    <h6 class="fw-bold mb-2">ì˜¤ì „</h6>
                                    <div id="amButtons" class="d-flex flex-wrap gap-2"></div>
                                </div>

                                <!-- ì˜¤í›„ -->
                                <div>
                                    <h6 class="fw-bold mb-2">ì˜¤í›„</h6>
                                    <div id="pmButtons" class="d-flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- ë²„íŠ¼ ì˜ì—­ -->
                        <div class="mt-4 text-end">
                            <a th:href="@{/lecture/new}"  class="btn btn-secondary">ì·¨ì†Œ</a>
                            <button type="button" id="registerBtn" class="btn btn-primary">ë“±ë¡</button>
                        </div>
                    </div>
                </form>
                <!-- âœ… í¼ ë -->
            </div>
        </div>
    </div>

    <!-- JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script>
        let picker;                  // daterangepicker ì¸ìŠ¤í„´ìŠ¤
        let isCalendarInitialized = false;

        // ë‹¬ë ¥ ìµœì´ˆ 1íšŒ ì´ˆê¸°í™”
        function initCalendarOnce() {
            if (isCalendarInitialized) return;

            $('#calendarInline').daterangepicker({
                parentEl: '#calendarInline',
                startDate: moment(),
                endDate: moment().add(1, 'days'),
                locale: {
                    format: 'YYYY-MM-DD',
                    separator: ' ~ ',
                    daysOfWeek: ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '],
                    monthNames: ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'],
                    firstDay: 0
                },
                opens: 'center',
                drops: 'down',
                alwaysShowCalendars: true,
                autoApply: true,
                singleDatePicker: false,
                autoUpdateInput: false
            });

            picker = $('#calendarInline').data('daterangepicker');

            // ì¸í’‹ ì—…ë°ì´íŠ¸ + ìš”ì¼/ì‹œê°„ ë²„íŠ¼ ê°±ì‹ 
            $('#calendarInline').on('apply.daterangepicker', function (ev, p) {
                $('#selectedRange').val(
                    p.startDate.format('YYYY-MM-DD') + ' ~ ' + p.endDate.format('YYYY-MM-DD')
                );
                updateDayOfWeekCheckboxes(p.startDate, p.endDate);

                // âœ… ë‹¬ë ¥ì—ì„œ ë²”ìœ„ë¥¼ ë°”ê¿¨ì„ ë•Œë„ ì‹œê°„ ë²„íŠ¼ ê°±ì‹ 
                const trainerId = getSelectedTrainerId();
                if (trainerId) {
                    refreshTimeButtons(trainerId, p.startDate, p.endDate, getAllowedDowSet());
                }
            });

            // íŒì˜¤ë²„ ë™ì‘ ì œê±°í•˜ê³  ìƒì‹œ í‘œì‹œ
            picker.hide = function(){};
            picker.show();

            // ì´ˆê¸° 1íšŒ: ì¸í’‹/ìš”ì¼ ê°±ì‹ 
            $('#selectedRange').val(
                picker.startDate.format('YYYY-MM-DD') + ' ~ ' + picker.endDate.format('YYYY-MM-DD')
            );
            updateDayOfWeekCheckboxes(picker.startDate, picker.endDate);

            isCalendarInitialized = true;
        }

        // ë²”ìœ„ ë³´ì • ìœ í‹¸
        function clampDate(d, min, max) {
            if (d.isBefore(min, 'day')) return min.clone();
            if (d.isAfter(max, 'day'))  return max.clone();
            return d.clone();
        }

        // íšŒì›ê¸°ê°„ ì œí•œ + ì˜¤ëŠ˜ ì´ì „ ë¸”ë¼ì¸ë“œ + startë¥¼ ì˜¤ëŠ˜ë¡œ ë§ì¶¤
        function lockCalendarToRangeKeepSelection(memberStart, memberEnd, opts = { startToday: true, blockPast: true }) {
            const memberMin = moment(memberStart, 'YYYY-MM-DD').startOf('day');
            const memberMax = moment(memberEnd,   'YYYY-MM-DD').endOf('day');
            const today     = moment().startOf('day');

            const minAllowed = opts.blockPast ? moment.max(memberMin, today) : memberMin;
            const maxAllowed = memberMax;

            if (minAllowed.isAfter(maxAllowed, 'day')) {
                picker.minDate = maxAllowed.clone();
                picker.maxDate = maxAllowed.clone();
                picker.isInvalidDate = () => true;
                picker.setStartDate(maxAllowed);
                picker.setEndDate(maxAllowed);
                $('#selectedRange').val(`${maxAllowed.format('YYYY-MM-DD')} ~ ${maxAllowed.format('YYYY-MM-DD')}`);
                picker.updateView();
                picker.updateCalendars();
                return;
            }

            picker.minDate = minAllowed;
            picker.maxDate = maxAllowed;
            picker.isInvalidDate = (date) => date.isBefore(minAllowed, 'day') || date.isAfter(maxAllowed, 'day');

            const prevStart = picker.startDate.clone();
            const prevEnd   = picker.endDate.clone();

            let newStart = opts.startToday ? clampDate(today, minAllowed, maxAllowed)
                : clampDate(prevStart, minAllowed, maxAllowed);
            let newEnd   = clampDate(prevEnd,   minAllowed, maxAllowed);
            if (newEnd.isBefore(newStart, 'day')) newEnd = newStart.clone();

            picker.setStartDate(newStart);
            picker.setEndDate(newEnd);

            $('#selectedRange').val(
                `${picker.startDate.format('YYYY-MM-DD')} ~ ${picker.endDate.format('YYYY-MM-DD')}`
            );

            picker.updateView();
            picker.updateCalendars();
        }

        let selectedMemberId = null;

        // íšŒì› í´ë¦­ ì‹œ: placeholder ìˆ¨ê¸°ê³  ë‹¬ë ¥ ë³´ì´ê¸° + ì´ˆê¸°í™” + ê¸°ê°„ ì œí•œ
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".member-row").forEach(function (row) {
                row.addEventListener("click", function () {
                    selectedMemberId = Number(this.dataset.memberId || 0); // â† ì„ íƒ íšŒì› ë³´ê´€
                    document.querySelectorAll(".member-row").forEach(r => r.classList.remove('selected'));
                    this.classList.add('selected');

                    document.getElementById('calendarPlaceholder').classList.add('d-none');
                    document.getElementById('calendarArea').classList.remove('d-none');

                    initCalendarOnce();

                    const memberStart = this.dataset.start;  // 'YYYY-MM-DD'
                    const memberEnd   = this.dataset.end;

                    // ì˜¤ëŠ˜ ì´ì „ ë¸”ë¼ì¸ë“œ + startë¥¼ ì˜¤ëŠ˜ë¡œ
                    lockCalendarToRangeKeepSelection(memberStart, memberEnd, { startToday: true, blockPast: true });

                    // âœ… ì‹œê°„ ë²„íŠ¼ ë¸”ë¼ì¸ë“œ í˜¸ì¶œ (íšŒì› ì„ íƒ ì§í›„ ì´ˆê¸° ìƒíƒœ ì„¸íŒ…)
                    const trainerId = getSelectedTrainerId();
                    if (trainerId) {
                        refreshTimeButtons(trainerId, picker.startDate, picker.endDate, getAllowedDowSet());
                    }
                });
            });
        });

        // ìš”ì¼ ì²´í¬ë°•ìŠ¤ í™œì„±/ë¹„í™œì„± ì—…ë°ì´íŠ¸
        function updateDayOfWeekCheckboxes(startMoment, endMoment) {
            if (!startMoment || !endMoment) return;

            const included = new Set();
            let cur = startMoment.clone().startOf('day');
            const last = endMoment.clone().startOf('day');
            while (cur.isSameOrBefore(last, 'day')) {
                included.add(cur.day());
                cur.add(1, 'day');
            }

            const map = { 'ì¼':0, 'ì›”':1, 'í™”':2, 'ìˆ˜':3, 'ëª©':4, 'ê¸ˆ':5, 'í† ':6 };

            document.querySelectorAll('input[name="dayOfWeek"]').forEach(cb => {
                const dow = map[cb.value];
                const enable = included.has(dow);
                cb.disabled = !enable;
                if (!enable) cb.checked = false;
                cb.parentElement.classList.toggle('dow-disabled', !enable);
            });
        }

        // í–‰ í´ë¦­ ì´ë²¤íŠ¸(íŠ¸ë ˆì´ë„ˆ ëª©ë¡ ì´ë™)
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".clickable-row").forEach(function (row) {
                row.addEventListener("click", function (e) {
                    if (e.target.closest('a') || e.target.closest('button') || e.target.type === 'checkbox') return;
                    window.location = this.dataset.href;
                });
            });
        });

        // ì‹œê°„ ë²„íŠ¼ ìƒì„±
        document.addEventListener("DOMContentLoaded", function () {
            const amContainer = document.getElementById("amButtons");
            const pmContainer = document.getElementById("pmButtons");

            for (let hour = 8; hour <= 11; hour++) amContainer.appendChild(createTimeButton(hour));
            for (let hour = 12; hour <= 23; hour++) pmContainer.appendChild(createTimeButton(hour));

            function createTimeButton(hour) {
                const button = document.createElement("button");
                button.type = "button";
                button.className = "btn btn-outline-dark time-btn";
                const hhmm = hour.toString().padStart(2, "0") + ":00";
                button.dataset.time = hhmm;
                button.textContent = hhmm;

                // ë¼ë””ì˜¤ì²˜ëŸ¼ í•œ ê°œë§Œ ì„ íƒ
                button.addEventListener("click", function () {
                    if (button.disabled) return; // âŒ ë¹„í™œì„±í™”ë©´ í´ë¦­ ë¬´ì‹œ
                    document.querySelectorAll(".time-btn").forEach(btn => {
                        btn.classList.remove("btn-dark");
                        btn.classList.add("btn-outline-dark");
                    });
                    this.classList.remove("btn-outline-dark");
                    this.classList.add("btn-dark");
                });

                return button;
            }
        });

        // âœ… ì˜¤ëŠ˜ ë‚ ì§œì¼ ê²½ìš° í˜„ì¬ ì‹œê°„ ì´ì „ ì‹œê°„ëŒ€ëŠ” disable ì²˜ë¦¬
        function disablePastTimesIfToday(startDateStr, endDateStr) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, "0");
            const dd = String(today.getDate()).padStart(2, "0");
            const todayStr = `${yyyy}-${mm}-${dd}`;

            // startì™€ endê°€ ê°™ê³ , ì˜¤ëŠ˜ì¼ ê²½ìš°ë§Œ ì²´í¬
            if (startDateStr === endDateStr && startDateStr === todayStr) {
                const nowHour = today.getHours();
                const nowMinute = today.getMinutes();

                document.querySelectorAll(".time-btn").forEach(btn => {
                    const [h, m] = btn.dataset.time.split(":").map(Number);

                    // í˜„ì¬ì‹œê°ë³´ë‹¤ ê³¼ê±°ë©´ ë¹„í™œì„±í™”
                    if (h < nowHour || (h === nowHour && m <= nowMinute)) {
                        btn.disabled = true;
                        btn.classList.add("btn-secondary");
                        btn.classList.remove("btn-outline-dark", "btn-dark");
                    } else {
                        btn.disabled = false;
                        btn.classList.remove("btn-secondary");
                    }
                });
            } else {
                // ì˜¤ëŠ˜ì´ ì•„ë‹ˆê±°ë‚˜ ê¸°ê°„ ì„ íƒ â†’ ì „ì²´ í™œì„±í™”
                document.querySelectorAll(".time-btn").forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove("btn-secondary");
                });
            }
        }

        // ğŸ“Œ daterangepicker ì„ íƒ ì‹œë§ˆë‹¤ ì‹¤í–‰
        $('#calendarInline').on('apply.daterangepicker', function (ev, p) {
            const startDate = p.startDate.format('YYYY-MM-DD');
            const endDate = p.endDate.format('YYYY-MM-DD');
            disablePastTimesIfToday(startDate, endDate);
        });

        // ì²´í¬ëœ ìš”ì¼ì…‹ (0=ì¼~6=í† )
        function getAllowedDowSet() {
            const map = {'ì¼':0,'ì›”':1,'í™”':2,'ìˆ˜':3,'ëª©':4,'ê¸ˆ':5,'í† ':6};
            const checked = Array.from(document.querySelectorAll('input[name="dayOfWeek"]:checked'));
            return new Set(checked.map(cb => map[cb.value])); // ë¹„ì—ˆìœ¼ë©´ size=0
        }

        // start~end ì‚¬ì´ì—ì„œ ìš”ì¼ í•„í„°ë¡œ ë‚ ì§œ ë¦¬ìŠ¤íŠ¸ ìƒì„±
        function buildDates(startMoment, endMoment, allowedDowSet) {
            const dates = [];
            let cur = startMoment.clone().startOf('day');
            while (cur.isSameOrBefore(endMoment, 'day')) {
                if (allowedDowSet.has(cur.day())) dates.push(cur.format('YYYY-MM-DD'));
                cur.add(1, 'day');
            }
            return dates;
        }

        // ë°±ì—”ë“œ í˜¸ì¶œ: { "YYYY-MM-DD": ["HH:mm", ...] }
        async function fetchBusyMap(trainerId, startDate, endDate) {
            try {
                const res = await $.getJSON(`/lecture/trainers/${trainerId}/busy`, { start: startDate, end: endDate });
                return res || {};
            } catch (e) {
                console.error('busy fetch failed', e);
                return {};
            }
        }

        // busyMap: { "YYYY-MM-DD": ["HH:mm", ...] }, dates: ["YYYY-MM-DD", ...]
        async function buildConflictInfoByTime(trainerId, busyMap, dates) {
            const byTime = {}; // { "HH:mm": [{date, name}, ...] }

            for (const d of dates) {
                const busyTimes = (busyMap[d] || []).map(t => t.slice(0,5)); // "HH:mm"ë¡œ ì •ê·œí™”
                if (!busyTimes.length) continue;

                const lessons = await fetchLessonsByDate(trainerId, d);
                // ë ˆìŠ¨ë„ "HH:mm"ë¡œ ì •ê·œí™”
                const norm = lessons.map(x => ({
                    time: (x.sessionTime || '').slice(0,5),
                    name: x.memberName || x.name || ''
                }));

                for (const t of busyTimes) {
                    const same = norm.filter(x => x.time === t);
                    if (!same.length) continue;
                    if (!byTime[t]) byTime[t] = [];
                    same.forEach(x => byTime[t].push({ date: d, name: x.name }));
                }
            }
            return byTime; // ì˜ˆ: { "10:00": [{date:"2025-08-12", name:"ê¹€ì˜í¬"}, ...] }
        }

        // ë‚ ì§œë³„ ë ˆìŠ¨ ìºì‹œ: key = `${trainerId}:${YYYY-MM-DD}` â†’ [{sessionTime, memberName}, ...]
        const dayLessonsCache = new Map();

        async function fetchLessonsByDate(trainerId, date) {
            const key = `${trainerId}:${date}`;
            if (dayLessonsCache.has(key)) return dayLessonsCache.get(key);

            const url = `/lecture/day?date=${encodeURIComponent(date)}&trainerId=${encodeURIComponent(trainerId)}`;
            const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
            if (!res.ok) { console.error('day fetch failed', date, res.status); dayLessonsCache.set(key, []); return []; }

            const list = await res.json(); // [{sessionTime:"HH:mm[:ss]", memberName:"..."}, ...]
            dayLessonsCache.set(key, list || []);
            return list || [];
        }

        // ê²½ê³  ì´ˆê¸°í™”/ë¦¬ì…‹(ë¹„í™œì„±í™”ëŠ” í•˜ì§€ ì•ŠìŒ)
        function resetTimeButtonsState() {
            document.querySelectorAll('.time-btn').forEach(btn => {
                const hhmm = (btn.dataset.time || btn.textContent.trim()).slice(0,5);
                btn.textContent = hhmm;
                btn.removeAttribute('title');
                btn.classList.remove('border','border-warning','btn-outline-secondary');
                // ì„ íƒ ì•ˆ ëœ ë²„íŠ¼ì€ outline-dark ìœ ì§€
                if (!btn.classList.contains('btn-dark')) {
                    btn.classList.add('btn-outline-dark');
                }
            });
        }

        // ê²½ê³  ì ìš©: ë…¸ë€ í…Œë‘ë¦¬ + íˆ´íŒ(â€œYYYY-MM-DD ì´ë¦„â€ ì¤„ë°”ê¿ˆ)
        function applyWarningUI(conflictInfoByTime) {
            document.querySelectorAll('.time-btn').forEach(btn => {
                const hhmm = (btn.dataset.time || btn.textContent.trim()).slice(0,5);
                btn.textContent = hhmm;

                const items = conflictInfoByTime[hhmm] || [];

                // ê¸°ë³¸ ë¦¬ì…‹
                btn.classList.remove('border','border-warning','btn-outline-secondary');
                btn.removeAttribute('title');

                if (items.length > 0) {
                    btn.classList.add('border','border-warning');
                    const tip = items.map(x => `${x.date} ${x.name}`.trim()).join('\n'); // ì¤„ë°”ê¿ˆ íˆ´íŒ
                    btn.setAttribute('title', tip);
                    btn.dataset.conflictInfo = tip; // (ë“±ë¡ ì‹œ ì°¸ê³ í•˜ë ¤ë©´ ìœ ì§€)
                } else {
                    delete btn.dataset.conflictInfo;
                }

                // ì„ íƒ ìƒíƒœ/outline-dark ìœ ì§€ (disable ì œê±°)
                if (!btn.classList.contains('btn-dark')) {
                    btn.classList.add('btn-outline-dark');
                }
            });
        }
        // ì „ì²´ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
        async function refreshTimeButtons(trainerId, startMoment, endMoment, allowedDowSet) {
            // ìš”ì¼ í•˜ë‚˜ë„ ì²´í¬ ì•ˆ í–ˆê±°ë‚˜, êµì§‘í•©ì´ ì—†ìœ¼ë©´ ê²½ê³ ë§Œ ë¦¬ì…‹(ë¹„í™œì„±í™” ì—†ìŒ)
            if (!allowedDowSet || allowedDowSet.size === 0) {
                resetTimeButtonsState();
                return;
            }

            const dates = buildDates(startMoment, endMoment, allowedDowSet);
            if (dates.length === 0) {
                resetTimeButtonsState();
                return;
            }

            // busy ë§µ (ë²”ìœ„ ìµœì†Œ~ìµœëŒ€)
            const busyMap = await fetchBusyMap(trainerId, dates[0], dates[dates.length - 1]);

            // ì‹œê°„ë³„ ê²½ê³  ì •ë³´(ë‚ ì§œ+ì´ë¦„)
            const conflictInfoByTime = await buildConflictInfoByTime(trainerId, busyMap, dates);

            // ê²½ê³ ë§Œ UI ë°˜ì˜
            applyWarningUI(conflictInfoByTime);
        }

        // âœ… ìš”ì¼ ì²´í¬ë°•ìŠ¤ ë³€í™” ì‹œë§ˆë‹¤ í˜¸ì¶œ
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input[name="dayOfWeek"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    const trainerId = getSelectedTrainerId();
                    if (!trainerId || !picker) return;
                    refreshTimeButtons(trainerId, picker.startDate, picker.endDate, getAllowedDowSet());
                });
            });
        });

        // ìš”ì¼ ë§µ(ì›”=1 â€¦ ì¼=7)
        const DOW_MAP = { 'ì›”':1, 'í™”':2, 'ìˆ˜':3, 'ëª©':4, 'ê¸ˆ':5, 'í† ':6, 'ì¼':7 };
        const DOW_MAP_MOMENT = { 'ì¼':0,'ì›”':1,'í™”':2,'ìˆ˜':3,'ëª©':4,'ê¸ˆ':5,'í† ':6 }; // moment ìš©

        // íŠ¸ë ˆì´ë„ˆ ID ì½ê¸° (pageMeta ë˜ëŠ” URL)
        function getSelectedTrainerId() {
            const el = document.getElementById('pageMeta');
            if (el && el.dataset.trainerId) return Number(el.dataset.trainerId);
            const m = location.pathname.match(/\/lecture\/(\d+)/);
            return m ? Number(m[1]) : null;
        }

        // ë“±ë¡ í´ë¦­
        document.getElementById('registerBtn').addEventListener('click', async () => {
            try{
                const trainerId = getSelectedTrainerId();
                if (!trainerId) return alert('ê°•ì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');

                const memberRow = document.querySelector('.member-row.selected');
                if (!memberRow) return alert('íšŒì›ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
                const memberId = Number(memberRow.dataset.memberId || 0);
                if (!memberId) return alert('íšŒì› ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');

                const packageId = Number(memberRow.dataset.packageId);

                // ì‹œê°„ ì„ íƒ
                const timeBtn = document.querySelector('.time-btn.btn-dark');
                if (!timeBtn) return alert('ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”.');
                const time = (timeBtn.dataset.time || timeBtn.textContent.trim()).slice(0, 5); // "HH:mm"

                // ê¸°ê°„ (daterangepicker)
                if (!picker) return alert('ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”.');
                const startDate = picker.startDate.format('YYYY-MM-DD');
                const endDate   = picker.endDate.format('YYYY-MM-DD');

                // ìš”ì¼(ì²´í¬ ì—†ìœ¼ë©´ ì „ì²´ ìš”ì¼ ì „ì†¡í•´ì„œ ì„œë²„ NPE ë°©ì§€)
                const checked = Array.from(document.querySelectorAll('input[name="dayOfWeek"]:checked'));
                const repeatDays = (checked.length ? checked : Array.from(document.querySelectorAll('input[name="dayOfWeek"]')))
                    .map(cb => DOW_MAP[cb.value])
                    .filter(Boolean);

                // ğŸ‘‰ ìš”ì²­ ì„¸ì…˜ ìˆ˜ ê³„ì‚° (picker ë²”ìœ„ ë‚´ì—ì„œ repeatDays ì ìš©)
                const allowedMomentDows = new Set(
                    (checked.length
                        ? checked.map(cb => DOW_MAP_MOMENT[cb.value])
                        : [0,1,2,3,4,5,6]) // ì²´í¬ê°€ ì—†ìœ¼ë©´ ì „ ìš”ì¼
                );
                let requestedCount = 0;
                let cur = picker.startDate.clone().startOf('day');
                const last = picker.endDate.clone().startOf('day');
                while (cur.isSameOrBefore(last, 'day')) {
                    if (allowedMomentDows.has(cur.day())) requestedCount++;
                    cur.add(1, 'day');
                }

                const remaining  = Number(memberRow.dataset.remaining || 0);
                // âœ… ì´ˆê³¼ ì‹œ í”„ë¡ íŠ¸ì—ì„œë§Œ ê²½ê³ /í™•ì¸
                if (requestedCount > remaining) {
                    const ok = confirm(
                        `PT íšŸìˆ˜ ì´ˆê³¼ ì…ë‹ˆë‹¤. ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nìš”ì²­: ${requestedCount}íšŒ / ì”ì—¬: ${remaining}íšŒ\n(ì§„í–‰ ì‹œ ì”ì—¬ëŠ” 0ì´ ë©ë‹ˆë‹¤)`
                    );
                    if (!ok) return; // "ì•„ë‹ˆìš”"ë©´ ì„œë²„ í˜¸ì¶œ ì•ˆ í•¨
                }

                // í˜ì´ë¡œë“œ (ì„œë¹„ìŠ¤ê°€ ê¸°ëŒ€í•˜ëŠ” í•„ë“œëª… ê·¸ëŒ€ë¡œ)
                const payload = {
                    trainerId,
                    memberId,
                    packageId,
                    startDate,   // "YYYY-MM-DD"
                    endDate,     // "YYYY-MM-DD"
                    time,        // "HH:mm"
                    repeatDays   // [1..7]
                };

                const res = await fetch('/lecture/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // ResponseDTO {message, body}
                const data = await res.json().catch(() => ({}));

                if (!res.ok) {
                    // ì˜ˆì™¸ê°€ Adviceì—ì„œ ê°ì‹¸ì§€ ì•Šì•˜ë‹¤ë©´ messageê°€ ì—†ì„ ìˆ˜ ìˆìŒ
                    return alert(data?.body?.error || data?.message || 'ë“±ë¡ ì‹¤íŒ¨');
                }

                // ì„±ê³µ
                alert(data.message || 'ì €ì¥ ì„±ê³µ');
                window.location.href = '/lecture/new';

            } catch (e) {
                console.error(e);
                alert(e.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
            }
        });

    </script>
</main>
</html>
