<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <title>수업 관리 · 리스트</title>

  <link rel="stylesheet" th:href="@{https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css}" />
  <link rel="stylesheet" th:href="@{https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css}">

  <style>
    .sticky-group { position: sticky; top: 0; z-index: 1020; }
    .session-row.imminent { border-left: 4px solid #0dcaf0; }
    .status-badge { min-width: 56px; }
    .summary-card .display-6 { line-height: 1; }
    @media (max-width: 768px) {
      .table-desktop { display:none; }
      .card-mobile { display:block; }
      .filterbar { flex-direction: column !important; align-items: stretch !important; }
      .filterbar > * { width: 100% !important; }
    }
    @media (min-width: 768px) { .card-mobile { display:none; } }
    .input-icon { position: relative; }
    .input-icon input { padding-right: 35px; }
    .input-icon i { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #6c757d; z-index: 2; }
    .daterangepicker { z-index: 2050 !important; }

    .fab-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1050; /* 모달, 네비보다 위 */
    }
  </style>
</head>
<main layout:fragment="content">
  <div class="container py-4">
    <!-- 상단: 필터바 -->
    <div class="mb-4">
      <h4 class="fw-bold mb-4">수업 관리</h4>
      <div class="d-flex align-items-center justify-content-between">

        <!-- ✅ GET 폼 -->
        <form class="d-flex align-items-center gap-2 filterbar"
              id="searchForm" method="get" th:action="@{/lecture/new}">

          <!-- 상태 필터 -->
          <div class="btn-group" role="group" aria-label="상태 필터">
            <input class="btn-check" type="checkbox" id="stBooked"
                   name="status" value="BOOKED"
                   th:checked="${#lists.contains(cond.status, 'BOOKED')}">
            <label class="btn btn-outline-secondary" for="stBooked" style="min-width:60px;">예약</label>

            <input class="btn-check" type="checkbox" id="stAtt"
                   name="status" value="ATTENDED"
                   th:checked="${#lists.contains(cond.status, 'ATTENDED')}">
            <label class="btn btn-outline-success" for="stAtt" style="min-width:60px;">출석</label>

            <input class="btn-check" type="checkbox" id="stNo"
                   name="status" value="NO_SHOW"
                   th:checked="${#lists.contains(cond.status, 'NO_SHOW')}">
            <label class="btn btn-outline-warning" for="stNo" style="min-width:60px;">결석</label>
          </div>

          <!-- 날짜 범위 -->
          <div class="input-icon" style="max-width:250px; min-width:250px; width:250px;">
            <!-- dateRange는 서버로 보내지 않음 -->
            <input type="text" id="dateRange" class="form-control" readonly />
            <i class="bi bi-calendar3" id="datePickerIcon"></i>
          </div>
          <!-- 서버 전송용 hidden 필드 -->
          <input type="hidden" name="startDate" id="startDate" th:value="${cond.startDate}">
          <input type="hidden" name="endDate" id="endDate" th:value="${cond.endDate}">

          <!-- 트레이너 -->
          <select class="form-select" name="trainerId"
                  style="max-width:180px; min-width:150px;"
                  th:value="${cond.trainerId}">
            <option th:value="${null}">전체 트레이너</option>
            <option th:each="t : ${trainers}"
                    th:value="${t.trainerId}"
                    th:text="${t.name}">
            </option>
          </select>

          <!-- 키워드 -->
          <input type="text" class="form-control" name="keyword"
                 style="max-width:220px; min-width:150px; width:150px"
                 placeholder="회원명/전화 검색" th:value="${cond.keyword}" />

          <!-- 검색 버튼 -->
          <button type="submit" class="btn btn-outline-secondary" style="min-width:60px;">검색</button>
        </form>

        <!-- 데스크톱: 오른쪽에 큰 버튼 -->
        <a th:href="@{/lecture/form}"
           class="btn btn-primary px-4 d-none d-md-inline-block">
          + 수업 등록
        </a>

        <!-- 데스크톱에서는 숨기고, 모바일에서만 보이도록 -->
        <a th:href="@{/lecture/form}"
           class="btn btn-primary fab-btn d-md-none">
          <i class="bi bi-plus"></i>
        </a>
      </div>
    </div>

    <!-- 요약 카드 -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3" th:each="summary : ${summaryList}">
        <div class="card summary-card shadow-sm border-0">
          <div class="card-body">
            <div class="small text-muted" th:text="${summary.label}">라벨</div>
            <div class="display-6 fw-bold"
                 th:text="${summary.isPercent} ? ${summary.value} + '%' : ${summary.value}">
              0
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 날짜 그룹 -->
    <div th:each="group : ${dateGroups}" class="mb-4">
      <!-- 날짜 헤더 -->
      <div class="bg-light border rounded px-3 py-2 mb-2 sticky-group">
        <div class="d-flex justify-content-between align-items-center">
          <span class="fw-semibold" th:text="${#temporals.format(group.date, 'MM/dd(E)')}"></span>
          <small class="text-muted"
                 th:text="'총 ' + ${group.total} + ' · 예약 ' + ${group.booked} + ' · 출석 ' + ${group.attended} + ' · 노쇼 ' + ${group.noShow} + ' · ' + ${group.rate} + '%'">
            총 0 · 예약 0 · 출석 0 · 노쇼 0 · 0%
          </small>
        </div>
      </div>

      <!-- 테이블 -->
      <div class="table-responsive table-desktop">
        <table class="table text-center align-middle bg-white rounded shadow-sm overflow-hidden">
          <thead class="table-light position-sticky top-0" style="z-index:1010">
          <tr>
            <th>시간</th>
            <th>회원</th>
            <th>트레이너</th>
            <th>상품</th>
            <th>상태</th>
            <th>관리</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="sess : ${group.sessions}"
              th:classappend="${sess.imminent} ? ' imminent' : ''"
              class="session-row">
            <td>
              <span class="fw-semibold" th:text="${sess.sessionTime}">09:00~09:50</span>
              <span class="badge text-bg-info ms-1" th:if="${sess.imminent}">임박</span>
            </td>
            <td>
              <span th:text="${sess.memberName}">홍길동</span>
              <small class="text-muted">· <span th:text="${sess.phone}">1234</span></small>
            </td>
            <td th:text="${sess.trainerName}">트레이너 김</td>
            <td>
              <span class="badge text-bg-secondary" th:text="${sess.productName}">PT 30회</span>
              <span class="badge text-bg-light border" th:text="'잔여 ' + ${sess.remainingCount} + '회'">잔여 10회</span>
            </td>
            <td>
                <span class="badge status-badge"
                      th:style="'background-color:' + ${sess.statusColor} + '; color:white;'"
                      th:text="${sess.label}">예약</span>
            </td>
            <td class="text-nowrap">
              <button type="button" class="btn btn-sm btn-success"
                      th:attr="data-member-id=${sess.memberId},
                 data-session-id=${sess.sessionId},
                 data-package-id=${sess.packageId},
                 data-status='ATTENDED'">
                O
              </button>

              <button type="button" class="btn btn-sm btn-warning"
                      th:attr="data-member-id=${sess.memberId},
                 data-session-id=${sess.sessionId},
                 data-package-id=${sess.packageId},
                 data-status='NO_SHOW'">
                X
              </button>

              <button type="button"
                      class="btn btn-outline-secondary btn-sm edit-btn"
                      th:data-session-id="${sess.sessionId}"
                      th:data-date="${#temporals.format(sess.sessionTime, 'yyyy-MM-dd')}"
                      th:data-time="${#temporals.format(sess.sessionTime, 'HH:mm')}"
                      th:data-trainer-id="${sess.trainerId}"
                      data-bs-toggle="modal"
                      data-bs-target="#editSessionModal">
                수정
              </button>

              <form th:action="@{/lecture/sessions/delete}" method="post" style="display:inline;">
                <input type="hidden" name="sessionId" th:value="${sess.sessionId}">
                <button type="submit" class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('정말 이 수업을 취소하시겠습니까?');">
                  취소
                </button>
              </form>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- 모바일 카드 뷰 -->
      <div class="card-mobile d-md-none">
        <div th:each="sess : ${group.sessions}"
             th:classappend="${sess.imminent} ? ' imminent' : ''"
             class="card shadow-sm mb-3">
          <div class="card-body">
            <!-- 시간 -->
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="fw-semibold" th:text="${sess.sessionTime}">09:00~09:50</span>
              <span class="badge text-bg-info" th:if="${sess.imminent}">임박</span>
            </div>

            <!-- 회원 -->
            <div class="mb-2">
              <span th:text="${sess.memberName}">홍길동</span>
              <small class="text-muted">· <span th:text="${sess.phone}">1234</span></small>
            </div>

            <!-- 트레이너 -->
            <div class="mb-2">
              <i class="bi bi-person-badge"></i>
              <span th:text="${sess.trainerName}">트레이너 김</span>
            </div>

            <!-- 상품 -->
            <div class="mb-2">
              <span class="badge text-bg-secondary" th:text="${sess.productName}">PT 30회</span>
              <span class="badge text-bg-light border" th:text="'잔여 ' + ${sess.remainingCount} + '회'">잔여 10회</span>
            </div>

            <!-- 상태 -->
            <div class="mb-2">
        <span class="badge status-badge"
              th:style="'background-color:' + ${sess.statusColor} + '; color:white;'"
              th:text="${sess.label}">예약</span>
            </div>

            <!-- 관리 버튼 -->
            <div class="d-flex gap-2 flex-wrap">
              <button type="button" class="btn btn-sm btn-success"
                      th:attr="data-member-id=${sess.memberId},
                         data-session-id=${sess.sessionId},
                         data-package-id=${sess.packageId},
                         data-status='ATTENDED'">O</button>

              <button type="button" class="btn btn-sm btn-warning"
                      th:attr="data-member-id=${sess.memberId},
                         data-session-id=${sess.sessionId},
                         data-package-id=${sess.packageId},
                         data-status='NO_SHOW'">X</button>

              <button type="button"
                      class="btn btn-outline-secondary btn-sm edit-btn"
                      th:data-session-id="${sess.sessionId}"
                      th:data-date="${#temporals.format(sess.sessionTime, 'yyyy-MM-dd')}"
                      th:data-time="${#temporals.format(sess.sessionTime, 'HH:mm')}"
                      th:data-trainer-id="${sess.trainerId}"
                      data-bs-toggle="modal"
                      data-bs-target="#editSessionModal">
                수정
              </button>

              <form th:action="@{/lecture/sessions/delete}" method="post" style="display:inline;">
                <input type="hidden" name="sessionId" th:value="${sess.sessionId}">
                <button type="submit" class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('정말 이 수업을 취소하시겠습니까?');">
                  취소
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 페이지네이션 -->
    <nav th:if="${totalPages > 1}" class="mt-4">
      <ul class="pagination justify-content-center">
        <!-- 이전 -->
        <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
          <a class="page-link" th:href="@{/lecture/list(page=${currentPage - 1})}">이전</a>
        </li>

        <!-- 번호 -->
        <li class="page-item" th:each="i : ${#numbers.sequence(1, totalPages)}"
            th:classappend="${currentPage == i} ? 'active'">
          <a class="page-link" th:href="@{/lecture/list(page=${i})}" th:text="${i}">1</a>
        </li>

        <!-- 다음 -->
        <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
          <a class="page-link" th:href="@{/lecture/list(page=${currentPage + 1})}">다음</a>
        </li>
      </ul>
    </nav>
  </div>

  <div class="modal fade" id="editSessionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- ✅ form submit 방식 -->
        <form th:action="@{/lecture/sessions/update}" method="post" id="editSessionForm">
          <div class="modal-header">
            <h5 class="modal-title">수업 수정</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <!-- hidden -->
            <input type="hidden" id="editSessionId" name="sessionId">

            <div class="mb-3">
              <label class="form-label">날짜</label>
              <input type="date" class="form-control" id="editDate" name="date" required>
            </div>

            <div class="mb-3">
              <label class="form-label">시간</label>
              <!-- flatpickr 적용 input -->
              <input type="text" class="form-control" id="editTime" name="time" required>
            </div>

            <div class="mb-3">
              <label class="form-label">트레이너</label>
              <select class="form-select" id="editTrainer" name="trainerId">
                <option th:each="t : ${trainers}"
                        th:value="${t.trainerId}"
                        th:text="${t.name}">
                </option>
              </select>
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">저장</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script th:src="@{https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js}"></script>
  <script th:src="@{https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js}"></script>
  <script th:src="@{https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js}"></script>
  <script th:src="@{https://cdn.jsdelivr.net/npm/flatpickr}"></script>
  <script th:src="@{https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js}"></script>
  <script th:inline="javascript">
    $(function() {
      // Thymeleaf 변수를 문자열로 안전하게 바인딩
      const startDateVal = /*[[${cond.startDate}]]*/ null;
      const endDateVal   = /*[[${cond.endDate}]]*/ null;

      const start = startDateVal ? moment(startDateVal, 'YYYY-MM-DD') : moment().startOf('month');
      const end   = endDateVal   ? moment(endDateVal, 'YYYY-MM-DD')   : moment().endOf('month');

      // datepicker 초기화
      $('#dateRange').daterangepicker({
        parentEl: 'body',
        locale: {
          format: 'YYYY-MM-DD',
          separator: ' ~ ',
          applyLabel: '확인',
          cancelLabel: '취소',
          daysOfWeek: ['일','월','화','수','목','금','토'],
          monthNames: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'],
          firstDay: 1
        },
        startDate: start,
        endDate: end,
        autoApply: false,
        opens: 'center',
        drops: 'down',
        autoUpdateInput: false
      }, function(s, e) {
        // 표시 + hidden 동기화
        $('#dateRange').val(s.format('YYYY-MM-DD') + ' ~ ' + e.format('YYYY-MM-DD'));
        $('#startDate').val(s.format('YYYY-MM-DD'));
        $('#endDate').val(e.format('YYYY-MM-DD'));
      });

      // 초기 표시/hidden 세팅
      $('#dateRange').val(start.format('YYYY-MM-DD') + ' ~ ' + end.format('YYYY-MM-DD'));
      $('#startDate').val(start.format('YYYY-MM-DD'));
      $('#endDate').val(end.format('YYYY-MM-DD'));

      // 아이콘 클릭 시 열기
      $('#datePickerIcon').on('click', function(e) {
        e.preventDefault();
        const drp = $('#dateRange').data('daterangepicker');
        if (drp) drp.show(); else $('#dateRange').trigger('click');
      });

      // 제출 전 방어코드(표시값 -> hidden 역파싱)
      $('#searchForm').on('submit', function() {
        const val = $('#dateRange').val() || '';
        if ((!$('#startDate').val() || !$('#endDate').val()) && val.includes('~')) {
          const parts = val.split('~').map(s => s.trim());
          if (parts.length === 2) {
            $('#startDate').val(parts[0]);
            $('#endDate').val(parts[1]);
          }
        }
      });
    });

    document.querySelectorAll("button[data-member-id]").forEach(btn => {
      btn.addEventListener("click", () => {
        const payload = {
          memberId: btn.dataset.memberId,
          sessionId: btn.dataset.sessionId,
          packageId: btn.dataset.packageId,
          status: btn.dataset.status
        };

        if (!confirm(`이 수업을 ${payload.status === 'ATTENDED' ? '출석' : '결석'} 처리하시겠습니까?`)) {
          return;
        }

        axios.post("/lecture/sessions/status", payload)
                .then(() => {
                  alert("처리되었습니다.");
                  location.reload();
                })
                .catch(err => {
                  console.error(err);
                  alert("오류가 발생했습니다.");
                });
      });
    });

    document.addEventListener("DOMContentLoaded", () => {
      // 모든 수정 버튼에 이벤트 연결
      document.querySelectorAll(".edit-btn").forEach(button => {
        button.addEventListener("click", () => {
          // data-* 속성 읽기
          const sessionId = button.dataset.sessionId;
          const date = button.dataset.date;
          const time = button.dataset.time;
          const trainerId = button.dataset.trainerId;

          console.log("세션 수정:", sessionId, date, time, trainerId);

          // 모달 안의 form 필드에 값 채우기
          document.getElementById("editSessionId").value = sessionId;
          document.getElementById("editDate").value = date;
          document.getElementById("editTime").value = time;
          document.getElementById("editTrainer").value = trainerId;
        });
      });
    });

    document.addEventListener("DOMContentLoaded", function () {
      flatpickr("#editTime", {
        enableTime: true,        // 시간 선택 활성화
        noCalendar: true,        // 날짜 제외
        dateFormat: "H:i",       // 24시간제 표시
        time_24hr: true,         // 24시간제
        minTime: "09:00",        // 시작 시간
        maxTime: "21:00",        // 종료 시간
        minuteIncrement: 60      // ✅ 정시 단위 (분 단위 선택 불가)
      });
    });

    //validation check
    document.addEventListener("DOMContentLoaded", () => {
      const dateInput = document.getElementById("editDate");
      const timeInput = document.getElementById("editTime");
      const form = document.getElementById("editSessionForm");

      // 오늘 날짜로 min 세팅
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      const todayStr = `${yyyy}-${mm}-${dd}`;
      dateInput.min = todayStr;

      form.addEventListener("submit", (e) => {
        if (!dateInput.value || !timeInput.value) {
          alert("날짜와 시간을 모두 입력하세요.");
          e.preventDefault();
          return;
        }

        const selectedDate = dateInput.value;
        const [h, m] = timeInput.value.split(":").map(Number);

        // 운영 시간 범위 체크
        if (h < 9 || h > 21 || (h === 21 && m > 0)) {
          alert("운영 시간은 09:00 ~ 21:00 사이만 가능합니다.");
          e.preventDefault();
          return;
        }

        // 오늘 날짜일 경우 현재시간+1 이후만 허용
        if (selectedDate === todayStr) {
          const selected = new Date(today);
          selected.setHours(h, m, 0, 0);

          const limit = new Date(today);
          limit.setHours(today.getHours() + 1, 0, 0, 0);

          if (selected < limit) {
            alert("현재 시간 기준 1시간 이후부터 예약 가능합니다.");
            e.preventDefault();
          }
        }
      });
    });

  </script>
</main>
</html>
