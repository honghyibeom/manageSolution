<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>ìˆ˜ì—… ì¼ì •í‘œ</title>
    <style>
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            background-color: white;
            padding: 1rem;
            border-radius: 10px;
        }

        .dayWeek-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            background-color: white;
            padding: 0.3rem 0.5rem;
        }

        .dayWeek-grid .calendar-cell {
            font-size: 1rem;
            line-height: 1;
            height: 28px;
            padding: 4px 0;
        }

        .calendar-cell {
            height: 80px;
            border-radius: 10px;
            text-align: center;
            line-height: 1.2;
            padding: 10px;
            font-size: 14px;
        }

        .empty-cell {
            background-color: transparent;
        }

        .selected {
            outline: 3px solid gray;
        }

        td:last-child, th:last-child {
            border-right: 1px solid #dee2e6 !important;
        }

        .calendar-cell:hover {
            background-color: #f0f0f0;
            cursor: pointer;
        }
    </style>
</head>

<body>
<main layout:fragment="content">
    <div class="container-fluid py-4">
        <div class="row">
            <h4 class="fw-bold mb-3">ìˆ˜ì—… ê´€ë¦¬</h4>
            <!-- â¬… ë‹¬ë ¥ -->
            <div class="col-md-5">
                <div class="card shadow-sm mb-5">
                    <div class="card-header fw-bold d-flex align-items-center justify-content-between mb-3">
                        ğŸ“…ìˆ˜ì—… í˜„í™©
                        <div class="d-flex align-items-center gap-2">
                            <label for="trainerId" class="form-label mb-0">íŠ¸ë ˆì´ë„ˆ</label>
                            <select class="form-select w-auto" id="trainerId" name="trainerId">
                                <option value="">íŠ¸ë ˆì´ë„ˆ ì„ íƒ</option>
                            </select>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="mb-2 d-flex justify-content-between align-items-center">
                            <button class="btn btn-outline-secondary btn-sm" onclick="prevMonth()">â—€ ì´ì „</button>
                            <h5 id="month-title" th:text="${year} + 'ë…„ ' + ${month} + 'ì›”'"></h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="nextMonth()">ë‹¤ìŒ â–¶</button>
                        </div>

                        <!-- ìš”ì¼ í—¤ë” -->
                        <div class="dayWeek-grid">
                            <div class="calendar-cell empty-cell fw-bold text-danger">ì¼</div>
                            <div class="calendar-cell empty-cell fw-bold">ì›”</div>
                            <div class="calendar-cell empty-cell fw-bold">í™”</div>
                            <div class="calendar-cell empty-cell fw-bold">ìˆ˜</div>
                            <div class="calendar-cell empty-cell fw-bold">ëª©</div>
                            <div class="calendar-cell empty-cell fw-bold">ê¸ˆ</div>
                            <div class="calendar-cell empty-cell fw-bold text-primary">í† </div>
                        </div>

                        <!-- ë‚ ì§œ ì…€ -->
                        <div class="calendar-grid" id="calendar-body">
                            <!-- JSë¡œ ë‚ ì§œ ì…€ ì±„ì›Œì§ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- â¡ ìˆ˜ì—… ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” -->
            <div class="col-md-7">
                <div class="card shadow-sm">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span>ğŸ—‚ ì„ íƒí•œ ë‚ ì§œ ìˆ˜ì—… ì¼ì •</span>
                        <span class="text-muted small">ì´ <strong id="lesson-count">0</strong>ê±´</span>
                    </div>

                    <div class="card-body">
                        <div class="scroll-table">
                            <table class="table table-bordered text-center align-middle">
                                <thead class="table-light">
                                <tr>
                                    <th><label>
                                        <input type="checkbox" onclick="toggleAll(this)">
                                    </label></th>
                                    <th>íšŒì›ëª…</th>
                                    <th>ë‚ ì§œ</th>
                                    <th>ì‹œê°„</th>
                                    <th>íŠ¸ë ˆì´ë„ˆ</th>
                                    <th>ì¶œì„</th>
                                </tr>
                                </thead>
                                <tbody id="lesson-table-body">
                                <tr><td colspan="6">ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- ë“±ë¡ / ì‚­ì œ ë²„íŠ¼ -->
                        <div class="mt-3 d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-primary" onclick="openRegisterModal()">ë“±ë¡</button>
                            <button type="button" class="btn btn-danger" onclick="deleteSelectedLessons()">ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- âœ… ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ include -->
    <div th:replace="~{lecture/modal :: registerModal}"></div>

    <!-- âœ… JS -->
    <script th:inline="javascript">
        let currentYear = [[${year}]];
        let currentMonth = [[${month}]];
        let selectedDate = null;

        // ìˆ˜ì—… ì¼ì • í…Œì´ë¸”ì—ì„œ ì „ì²´ ì„ íƒê¸°ëŠ¥
        function toggleAll(source) {
            const checkboxes = document.querySelectorAll("input[name='lessonCheckbox']");
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        // ì¼ˆë¦°ë” ë‚ ì§œ ìƒì„± ë° ìˆ˜ì—… ê±´ìˆ˜ ìƒì„±
        function loadCalendar(year, month) {
            const trainerId = document.getElementById("trainerId").value;

            fetch(`/lecture/month?year=${year}&month=${month}${trainerId ? `&trainerId=${trainerId}` : ""}`)
                .then(res => res.json())
                .then(data => drawCalendar(year, month, data));
        }

        // ì¼ˆë¦°ë” í¼ ìƒì„±
        function drawCalendar(year, month, lessons) {
            const calendarBody = document.getElementById("calendar-body");
            calendarBody.innerHTML = "";

            const firstDate = new Date(year, month - 1, 1);
            const startDay = firstDate.getDay(); // ì¼ìš”ì¼ = 0
            const lastDate = new Date(year, month, 0).getDate();

            for (let i = 0; i < startDay; i++) {
                const empty = document.createElement("div");
                empty.className = "calendar-cell empty-cell";
                calendarBody.appendChild(empty);
            }

            for (let i = 1; i <= lastDate; i++) {
                const cell = document.createElement("div");
                cell.className = "calendar-cell calendar-box";
                const lesson = lessons.find(l => l.day === i && l.enabled);

                cell.innerHTML = `<div style="font-size: 1.2rem;">${i}</div>`;
                if (lesson && lesson.lessonCount > 0) {
                    cell.innerHTML += `<div style="font-size:0.8rem; margin-top: 8px;">ìˆ˜ì—… ${lesson.lessonCount}ê±´</div>`;
                }

                cell.onclick = () => {
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    document.querySelectorAll('.calendar-box').forEach(e => e.classList.remove("selected"));
                    cell.classList.add("selected");
                    selectedDate = dateStr;
                    loadLessonList(dateStr);
                };

                calendarBody.appendChild(cell);
            }

            document.getElementById("month-title").innerText = `${year}ë…„ ${month}ì›”`;
        }

        // ì¼ˆë¦°ë” í´ë¦­í–‡ì„ë•Œ
        function loadLessonList(date) {
            const trainerId = document.getElementById("trainerId").value;

            fetch(`/lecture/day?date=${date}${trainerId ? `&trainerId=${trainerId}` : ""}`)
                .then(res => res.json())
                .then(data => {
                    console.log("ğŸš¨ ë°›ì•„ì˜¨ ë°ì´í„°:", data); // ğŸ‘ˆ ë°ì´í„° í˜•íƒœ í™•ì¸
                    const tbody = document.getElementById("lesson-table-body");
                    const count = document.getElementById("lesson-count");

                    if (data.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="6">ì˜ˆì•½ëœ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                        count.innerText = "0";
                        return;
                    }


                    count.innerText = data.length;
                    tbody.innerHTML = data.map(item => `
                        <tr>
                            <td><input type="checkbox" name="lessonCheckbox" value="${item.sessionId}"></td>
                            <td>${item.memberName}</td>
                            <td>${item.sessionDate}</td>
                            <td>${item.sessionTime}</td>
                            <td>${item.trainerName}</td>
                            <td>
                                ${item.attended ?
                                        (item.status === 'NOSHOW'
                                                ? `<button class="btn btn-sm btn-danger px-4 py-2 fs-5" disabled>ê²°ì„</button>`
                                                    : `<button class="btn btn-sm btn-success px-4 py-2 fs-5" disabled>ì¶œì„ ì™„ë£Œ</button>`)
                                                    : `<button class="btn btn-sm btn-outline-success px-4 py-2 fs-5"
                                                                onclick="markAttendance(${item.memberId}, ${item.sessionId}, ${item.packageId}, true)">
                                                                O
                                                                </button>
                                                    <button class="btn btn-sm btn-outline-danger px-4 py-2 fs-5"
                                                                onclick="markAttendance(${item.memberId}, ${item.sessionId}, ${item.packageId}, false)">
                                                                X
                                                                </button>`}
                            </td>
                        </tr>
                    `).join("");
                });
        }
        // ì¶œì„ ì²´í¬
        function markAttendance(memberId, sessionId, packageId, isAttended) {
            if (!confirm(isAttended === true ? "ì¶œì„ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ê²°ì„ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const payload = {
                memberId: memberId,
                sessionId: sessionId,
                packageId: packageId,
                status: isAttended === true ? "ATTENDED" : "NOSHOW"
            };

            fetch("/lecture/attend", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(() => {
                    alert("ì²˜ë¦¬ ì™„ë£Œ");
                    loadCalendar(currentYear, currentMonth);
                    loadLessonList(selectedDate);
                })
                .catch(err => {
                    alert("ì²˜ë¦¬ ì‹¤íŒ¨: " + err.message);
                });
        }

        // ì €ë²ˆë‹¬ ë²„íŠ¼
        function prevMonth() {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            loadCalendar(currentYear, currentMonth);
        }

        // ë‹¤ìŒë‹¬ ë²„íŠ¼
        function nextMonth() {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
            loadCalendar(currentYear, currentMonth);
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadCalendar(currentYear, currentMonth);
        });

        // ëª¨ë‹¬ì°½ ì˜¤í”ˆ
        function openRegisterModal() {
            if (!selectedDate) {
                alert("ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
                return;
            }

            // ğŸ” ìˆ˜ì •: sessionDateì— ì„ íƒí•œ ë‚ ì§œë¥¼ ë„£ìŒ
            const dateInput = document.getElementById("sessionDate");
            if (!dateInput) {
                console.error("âŒ sessionDate input ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            loadTrainerList("trainerIdModal");
            dateInput.value = selectedDate;

            const modal = new bootstrap.Modal(document.getElementById('registerModal'));
            modal.show();
        }

        // ëª¨ë“  íŠ¸ë ˆì´ë„ˆ ì¡°íšŒ
        function loadTrainerList(targetId = "trainerId") {
            const select = document.getElementById(targetId);
            select.innerHTML = '<option value="">íŠ¸ë ˆì´ë„ˆ ì„ íƒ</option>';

            fetch("/lecture/trainers")
                .then(res => res.json())
                .then(trainers => {
                    trainers.forEach(t => {
                        const option = document.createElement("option");
                        option.value = t.trainerId;
                        option.textContent = t.name;
                        select.appendChild(option);
                    });
                });
        }

        // íŠ¸ë ˆì´ë„ˆë¥¼ ì„ íƒí–ˆì„ë•Œ ë“±ë¡í•œ íšŒì› ì¡°íšŒ
        function loadMembersByTrainer(trainerId) {
            const memberSelect = document.getElementById("memberId");
            memberSelect.innerHTML = '<option value="">íšŒì› ì„ íƒ</option>'; // ì´ˆê¸°í™”

            if (!trainerId) return;

            fetch(`/lecture/members?trainerId=${trainerId}`)
                .then(res => res.json())
                .then(members => {
                    members.forEach(member => {
                        const option = document.createElement("option");
                        option.value = member.memberId;
                        option.textContent = member.name;
                        memberSelect.appendChild(option);
                    });
                })
                .catch(err => {
                    alert("íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    console.error(err);
                });
        }

        // íšŒì› ì„ íƒí–ˆì„ë•Œ ìƒí’ˆId ë°˜í™˜ (PtSession ì €ì¥ì„ í•˜ê¸°ìœ„í•´)
        function loadPackageByMember(memberId) {
            const packageInput = document.getElementById("packageId");

            packageInput.value = "";

            if (!memberId) return;

            fetch(`/lecture/package/active?memberId=${memberId}`)
                .then(res => res.json())
                .then(data => {
                    if (data && data.packageId) {
                        packageInput.value = data.packageId;
                    } else {
                        alert("ì´ íšŒì›ì€ ì‚¬ìš© ê°€ëŠ¥í•œ PT ì´ìš©ê¶Œì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                })
                .catch(err => {
                    alert("íŒ¨í‚¤ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    console.error(err);
                });
        }

        // ìˆ˜ì—… ì‚­ì œ
        function deleteSelectedLessons() {
            const checkedBoxes = document.querySelectorAll("input[name='lessonCheckbox']:checked");
            if (checkedBoxes.length === 0) {
                alert("ì‚­ì œí•  ìˆ˜ì—…ì„ ì„ íƒí•˜ì„¸ìš”.");
                return;
            }

            const confirmed = confirm("ì„ íƒí•œ ìˆ˜ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if (!confirmed) return;

            const sessionIds = Array.from(checkedBoxes).map(cb => cb.value);

            fetch("/lecture/delete", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(sessionIds)
            })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        loadCalendar(currentYear, currentMonth);
                        loadLessonList(selectedDate);
                    } else {
                        alert("ì‚­ì œ ì‹¤íŒ¨: " + result.message);
                    }
                })
                .catch(err => {
                    alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
                    console.error(err);
                });
        }

        //ìˆ˜ì—… ë°˜ë³µ ë“±ë¡ ì—¬ë¶€
        document.getElementById("repeatEnabled").addEventListener("change", function () {
            const options = document.getElementById("repeatOptions");
            options.style.display = this.checked ? "block" : "none";
        });

        // í˜ì´ì§€ ë¡œë“œí• ë•Œ
        document.addEventListener("DOMContentLoaded", () => {
            loadTrainerList("trainerId");

            const form = document.getElementById("registerForm");

            form.addEventListener("submit", function (e) {
                e.preventDefault(); // í˜ì´ì§€ ë¦¬ë¡œë“œ ë§‰ê¸°

                const formData = new FormData(form);

                // âœ… ë°˜ë³µ ë“±ë¡ ê´€ë ¨ ê°’ ì¶”ê°€
                if (document.getElementById("repeatEnabled").checked) {
                    formData.append("repeat", "true");

                    formData.append("repeatWeeks", document.getElementById("repeatWeeks").value);
                } else {
                    formData.append("repeat", "false");
                }

                fetch("/lecture/register", {
                    method: "POST",
                    body: new URLSearchParams(formData),
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    }
                })
                    .then(res => res.json())
                    .then(data => {
                        alert("ìˆ˜ì—…ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        bootstrap.Modal.getInstance(document.getElementById("registerModal")).hide();
                        loadCalendar(currentYear, currentMonth);
                        loadLessonList(selectedDate);
                        loadTrainerList("trainerId");
                    })
                    .catch(err => {
                        alert("ë“±ë¡ ì‹¤íŒ¨: " + err.message);
                    });
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            loadCalendar(currentYear, currentMonth);

            // ì˜¤ëŠ˜ ë‚ ì§œ ì„ íƒ
            const today = new Date();
            if (today.getFullYear() === currentYear && today.getMonth() + 1 === currentMonth) {
                const todayStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                selectedDate = todayStr;

                // ì ì‹œ delay ì£¼ê³  ì„ íƒ í´ë˜ìŠ¤ ë¶€ì—¬
                setTimeout(() => {
                    const calendarCells = document.querySelectorAll(".calendar-box");
                    calendarCells.forEach(cell => {
                        if (cell.innerText.trim().startsWith(today.getDate())) {
                            cell.classList.add("selected");
                        }
                    });
                }, 100);

                loadLessonList(todayStr);
            }
        });

        // íŠ¸ë ˆì´ë„ˆ ë“œë¡­ë‹¤ìš´ ë³€ê²½ì‹œ
        document.getElementById("trainerId").addEventListener("change", () => {
            // ë‹¬ë ¥ ìƒˆë¡œê³ ì¹¨ (ì„ íƒëœ íŠ¸ë ˆì´ë„ˆ ê¸°ì¤€ìœ¼ë¡œ)
            loadCalendar(currentYear, currentMonth);

            if (selectedDate) {
                loadLessonList(selectedDate);
            }
        });
    </script>
</main>
</body>
</html>
