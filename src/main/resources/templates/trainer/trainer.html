<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>강사 관리</title>
    <style>
        .scroll-table {
            max-height: 500px;
            overflow-y: auto;
        }
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background-color: #f8f9fa; }

        /* 모바일 카드 스타일 */
        .card-mobile .card {
            border-radius: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-mobile .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.08);
        }
        .card-mobile .card-body p {
            margin-bottom: 0.6rem;
        }

        /* ✅ 반응형 처리 */
        @media (max-width: 991.98px) {
            .table-desktop { display: none; }
            .card-mobile { display: block; }
        }
        @media (min-width: 992px) {
            /*.table-desktop { display: block; }*/
            .card-mobile { display: none; }
        }
    </style>
</head>

<main layout:fragment="content">
        <div class="container">
            <h4 class="fw-bold mb-4">
                <i class="bi bi-person-badge-fill text-primary me-2"></i> 강사 관리
            </h4>

            <!-- 트레이너 목록 -->
            <div class="row justify-content-center">
                <div class="col-12 col-md-10 mb-4">
                    <div class="card shadow-sm border border-secondary">
                        <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">
                    <i class="bi bi-people-fill me-2 text-secondary"></i> 강사 목록
                </span>
                            <a th:href="@{/trainer/register}" class="btn btn-sm btn-primary">
                                <i class="bi bi-plus-lg me-1"></i> 강사 등록
                            </a>
                        </div>
                        <div class="card-body scroll-table">
                            <!-- 데스크탑 테이블 -->
                            <table class="table table-striped table-hover text-center align-middle table-desktop">
                                <thead class="table-light">
                                <tr>
                                    <th>이름</th>
                                    <th>연락처</th>
                                    <th>성별</th>
                                    <th>생년월일</th>
                                    <th>이메일</th>
                                    <th>경력</th>
                                    <th>수당</th>
                                    <th>월급</th>
                                    <th>관리</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="pt : ${trainers}"
                                    th:attr="data-href=@{'/trainer/' + ${pt.trainerId}}"
                                    th:classappend="${selectedTrainerId == pt.trainerId} ? 'table-primary'"
                                    class="clickable-row">
                                    <td th:text="${pt.name}"></td>
                                    <td th:text="${pt.phone}"></td>
                                    <td th:text="${pt.gender}"></td>
                                    <td th:text="${#temporals.format(pt.birthDate, 'yyyy-MM-dd')}"></td>
                                    <td th:text="${pt.email}"></td>
                                    <td th:text="${pt.careerYears} + '년'"></td>
                                    <td class="fw-bold text-primary"
                                        th:text="${#numbers.formatInteger(pt.payPerSession, 0, 'COMMA')}"></td>
                                    <td class="fw-bold text-primary"
                                        th:text="${#numbers.formatInteger(pt.baseSalary, 0, 'COMMA')}"></td>
                                    <td>
                                        <a th:href="@{'/trainer/' + ${pt.trainerId} + '/edit'}"
                                           class="btn btn-sm btn-outline-secondary">수정</a>
                                        <form th:action="@{'/trainer/' + ${pt.trainerId} + '/delete'}" method="post" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    onclick="return confirm('정말 삭제하시겠습니까?')">삭제</button>
                                        </form>
                                    </td>
                                </tr>
                                </tbody>
                            </table>

                            <!-- 모바일 카드 -->
                            <div class="card-mobile">
                                <div th:each="pt : ${trainers}"
                                     class="card mb-3 shadow-sm border border-secondary clickable-row"
                                     th:attr="data-href=@{'/trainer/' + ${pt.trainerId}}">
                                    <div class="card-body py-3 px-3">
                                        <h5 class="fw-bold mb-2">
                                            <i class="bi bi-person-circle text-primary me-2"></i>
                                            <span th:text="${pt.name}"></span>
                                        </h5>
                                        <p class="mb-1"><i class="bi bi-telephone me-2"></i><span th:text="${pt.phone}"></span></p>
                                        <p class="mb-1"><i class="bi bi-gender-ambiguous me-2"></i><span th:text="${pt.gender}"></span></p>
                                        <p class="mb-1"><i class="bi bi-calendar-event me-2"></i><span th:text="${#temporals.format(pt.birthDate, 'yyyy-MM-dd')}"></span></p>
                                        <p class="mb-1"><i class="bi bi-envelope me-2"></i><span th:text="${pt.email}"></span></p>
                                        <p class="mb-1"><i class="bi bi-award me-2"></i>경력: <span th:text="${pt.careerYears}"></span>년</p>
                                        <p class="mb-1 fw-bold text-primary"><i class="bi bi-cash-coin me-2"></i>수당: <span th:text="${#numbers.formatInteger(pt.payPerSession,0,'COMMA')}"></span></p>
                                        <p class="mb-1 fw-bold text-primary"><i class="bi bi-cash-stack me-2"></i>월급: <span th:text="${#numbers.formatInteger(pt.baseSalary,0,'COMMA')}"></span></p>
                                        <div class="mt-3 d-flex justify-content-end gap-2">
                                            <a th:href="@{'/trainer/' + ${pt.trainerId} + '/edit'}" class="btn btn-sm btn-outline-secondary">수정</a>
                                            <form th:action="@{'/trainer/' + ${pt.trainerId} + '/delete'}" method="post">
                                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                                        onclick="return confirm('정말 삭제하시겠습니까?')">삭제</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div> <!-- card-mobile -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 해당 트레이너 회원 목록 -->
            <div class="row justify-content-center">
                <div class="col-12 col-md-10">
                    <div class="card shadow-sm">
                        <div class="card-header fw-bold">
                            <span th:if="${selectedTrainerId != null}">강사 회원 목록</span>
                            <span th:if="${selectedTrainerId == null}" class="text-muted">강사를 선택해주세요</span>
                        </div>

                        <!-- ✅ 폼으로 감싸기 -->
                        <form th:action="@{/trainer/change}" method="post">
                            <div class="card-body scroll-table">

                                <!-- ✅ 데스크톱 테이블 -->
                                <table class="table table-striped table-hover text-center align-middle table-desktop"
                                       th:if="${ptMembers != null and !ptMembers.isEmpty()}">
                                    <thead class="table-light">
                                    <tr>
                                        <th><input type="checkbox" id="selectAll" onclick="toggleAll(this)"/></th>
                                        <th>이름</th>
                                        <th>연락처</th>
                                        <th>생년월일</th>
                                        <th>사용 횟수</th>
                                        <th>남는 횟수</th>
                                        <th>시작일</th>
                                        <th>종료일</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="pm : ${ptMembers}">
                                        <td><input name="selectedMemberIds" th:value="${pm.memberId}" type="checkbox"/></td>
                                        <td th:text="${pm.name}"></td>
                                        <td th:text="${pm.phone}"></td>
                                        <td th:text="${#temporals.format(pm.birth, 'yyyy-MM-dd')}"></td>
                                        <td th:text="${pm.remainingCount}"></td>
                                        <td th:text="${pm.totalCount}"></td>
                                        <td th:text="${#temporals.format(pm.startDate, 'yyyy-MM-dd')}"></td>
                                        <td th:text="${#temporals.format(pm.endDate, 'yyyy-MM-dd')}"></td>
                                    </tr>
                                    </tbody>
                                </table>

                                <!-- ✅ 모바일 카드 -->
                                <div class="card-mobile" th:if="${ptMembers != null and !ptMembers.isEmpty()}">
                                    <div th:each="pm : ${ptMembers}" class="card mb-3 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="fw-bold mb-2" th:text="${pm.name}">회원명</h6>
                                                <input name="selectedMemberIds" th:value="${pm.memberId}" type="checkbox"/>
                                            </div>
                                            <p class="mb-1"><strong>연락처:</strong> <span th:text="${pm.phone}"></span></p>
                                            <p class="mb-1"><strong>생년월일:</strong> <span th:text="${#temporals.format(pm.birth, 'yyyy-MM-dd')}"></span></p>
                                            <p class="mb-1"><strong>사용 횟수:</strong> <span th:text="${pm.remainingCount}"></span></p>
                                            <p class="mb-1"><strong>남는 횟수:</strong> <span th:text="${pm.totalCount}"></span></p>
                                            <p class="mb-1"><strong>시작일:</strong> <span th:text="${#temporals.format(pm.startDate, 'yyyy-MM-dd')}"></span></p>
                                            <p class="mb-1"><strong>종료일:</strong> <span th:text="${#temporals.format(pm.endDate, 'yyyy-MM-dd')}"></span></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- ✅ 데이터 없을 때 -->
                                <p class="text-muted" th:if="${ptMembers == null or ptMembers.isEmpty()}">
                                    등록된 회원이 없습니다.
                                </p>
                            </div>

                            <!-- ✅ 일괄 트레이너 변경 영역 -->
                            <div class="card-footer d-flex justify-content-end align-items-center gap-2"
                                 th:if="${ptMembers != null and !ptMembers.isEmpty()}">
                                <label>
                                    <select name="newTrainerId" class="form-select w-auto">
                                        <option value="">트레이너 선택</option>
                                        <option th:each="t : ${trainers}" th:value="${t.trainerId}" th:text="${t.name}"></option>
                                    </select>
                                </label>
                                <button type="submit" class="btn btn-outline-primary"
                                        onclick="return confirm('선택된 회원들의 트레이너를 변경하시겠습니까?')">
                                    트레이너 변경
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    <!-- ✅ 행 클릭 스크립트 -->
    <script>
        function toggleAll(masterCheckbox) {
            document.querySelectorAll("input[name='selectedMemberIds']").forEach(cb => {
                cb.checked = masterCheckbox.checked;
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".clickable-row").forEach(function (row) {
                row.addEventListener("click", function (e) {
                    if (e.target.closest('a') || e.target.closest('button')) return;
                    window.location = this.dataset.href;
                });
            });
        });
    </script>
</main>
</html>
